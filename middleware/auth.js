const { query } = require('../config/database');

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function requireAuth(req, res, next) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
        if (!req.session.userId) {
            return res.status(401).json({
                error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                redirectTo: '/login'
            });
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const userResult = await query(
            'SELECT id, username, role, full_name, is_active FROM users WHERE id = $1',
            [req.session.userId]
        );

        if (!userResult.rows.length || !userResult.rows[0].is_active) {
            req.session.destroy();
            return res.status(401).json({
                error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
                redirectTo: '/login'
            });
        }

        req.user = userResult.rows[0];
        next();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
        res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
    }
}

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function requireRole(allowedRoles) {
    return (req, res, next) => {
        if (!req.user) {
            return res.status(401).json({ error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' });
        }

        if (!allowedRoles.includes(req.user.role)) {
            return res.status(403).json({
                error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞',
                required: allowedRoles,
                current: req.user.role
            });
        }

        next();
    };
}

// Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
async function requireScanAuth(req, res, next) {
    try {
        if (!req.session.userId) {
            return res.status(401).json({
                error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
                redirectTo: '/login'
            });
        }

        const userResult = await query(
            'SELECT id, username, role, full_name, is_active FROM users WHERE id = $1',
            [req.session.userId]
        );

        if (!userResult.rows.length || !userResult.rows[0].is_active) {
            req.session.destroy();
            return res.status(401).json({
                error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
                redirectTo: '/login'
            });
        }

        const user = userResult.rows[0];

        if (!['admin', 'moderator', 'skd'].includes(user.role)) {
            return res.status(403).json({
                error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'
            });
        }

        req.user = user;
        next();
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
    }
}

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function logUserAction(action) {
    return async (req, res, next) => {
        try {
            const logData = {
                userId: req.user?.id,
                action: action,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
                timestamp: new Date(),
                path: req.path,
                method: req.method
            };

            if (process.env.NODE_ENV === 'development') {
                console.log('üë§ –î–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', logData);
            }

            next();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è:', err);
            next();
        }
    };
}

// ========== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ==========

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
function canModifyVisitor(req, res, next) {
    const userRole = req.user.role;

    // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ
    if (['admin', 'moderator'].includes(userRole)) {
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π',
        required_roles: ['admin', 'moderator'],
        current_role: userRole
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
function canBlockVisitor(req, res, next) {
    const userRole = req.user.role;

    if (['admin', 'moderator'].includes(userRole)) {
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π',
        required_roles: ['admin', 'moderator'],
        current_role: userRole
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function canManageUsers(req, res, next) {
    const userRole = req.user.role;

    if (userRole === 'admin') {
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
        required_roles: ['admin'],
        current_role: userRole
    });
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è UUID –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
function validateVisitorUUID(req, res, next) {
    const { uuid } = req.params;

    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

    if (!uuid || !uuidRegex.test(uuid)) {
        return res.status(400).json({
            error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è'
        });
    }

    next();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
async function canEditVisitor(req, res, next) {
    try {
        const { id } = req.params;
        const userRole = req.user.role;
        const userId = req.user.id;

        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±–æ–≥–æ
        if (userRole === 'admin') {
            return next();
        }

        // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
        if (userRole === 'moderator') {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
            // - –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–≤–æ–∏—Ö —Å–æ–±—ã—Ç–∏–π
            // - –ò–ª–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã—Ö —Å–∞–º —Å–æ–∑–¥–∞–ª

            // –ü–æ–∫–∞ —á—Ç–æ —Ä–∞–∑—Ä–µ—à–∞–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö
            return next();
        }

        // –°–ö–î –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        return res.status(403).json({
            error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π',
            required_roles: ['admin', 'moderator'],
            current_role: userRole
        });

    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:', err);
        res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞
function canModifyBarcode(req, res, next) {
    const userRole = req.user.role;

    // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥—ã
    if (userRole === 'admin') {
        return next();
    }

    // –î–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø—ã—Ç–∞–µ—Ç—Å—è –ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥
    if (userRole === 'moderator') {
        const { barcode } = req.body;

        // –ï—Å–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π, –∑–Ω–∞—á–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ—Ç
        if (!barcode || barcode.trim() === '') {
            return next();
        }

        // –ï—Å–ª–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –ø–µ—Ä–µ–¥–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏ –æ–Ω –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
        // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–µ route
        req.barcodeModificationAttempt = true;
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–∞',
        required_roles: ['admin'],
        current_role: userRole
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
function checkEditLimits(req, res, next) {
    const userRole = req.user.role;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    const limits = {
        admin: { daily_edits: null }, // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        moderator: { daily_edits: 50 }, // 50 —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –¥–µ–Ω—å
        skd: { daily_edits: 0 } // –°–ö–î –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    };

    const userLimits = limits[userRole];

    // –ï—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (null), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    if (userLimits.daily_edits === null) {
        return next();
    }

    // –ï—Å–ª–∏ –ª–∏–º–∏—Ç 0, –±–ª–æ–∫–∏—Ä—É–µ–º
    if (userLimits.daily_edits === 0) {
        return res.status(403).json({
            error: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ä–æ–ª–∏',
            current_role: userRole
        });
    }

    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –¥–µ–Ω—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

    next();
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
function canExportData(req, res, next) {
    const userRole = req.user.role;

    if (['admin', 'moderator', 'skd'].includes(userRole)) {
        req.exportPermissions = {
            canExportVisitors: ['admin', 'moderator'].includes(userRole),
            canExportUsers: userRole === 'admin',
            canExportScans: true,
            canExportEvents: ['admin', 'moderator'].includes(userRole),
            canViewPersonalData: ['admin', 'moderator'].includes(userRole)
        };
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö'
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
function canExportScanStatistics(req, res, next) {
    const userRole = req.user.role;

    if (['admin', 'moderator', 'skd'].includes(userRole)) {
        req.exportPermissions = {
            canViewPersonalData: ['admin', 'moderator'].includes(userRole),
            canViewAllEvents: ['admin', 'moderator'].includes(userRole),
            canViewDetailedStats: true,
            maxExportRows: userRole === 'admin' ? null : 1000
        };
        return next();
    }

    return res.status(403).json({
        error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏'
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞
function checkExportLimits(req, res, next) {
    const userRole = req.user.role;
    const { limit, date_from, date_to } = req.query;

    const limits = {
        admin: { maxRows: null, maxDaysRange: null },
        moderator: { maxRows: 5000, maxDaysRange: 365 },
        skd: { maxRows: 1000, maxDaysRange: 30 }
    };

    const userLimits = limits[userRole];

    if (userLimits.maxRows && limit && parseInt(limit) > userLimits.maxRows) {
        return res.status(400).json({
            error: `–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞. –ú–∞–∫—Å–∏–º—É–º ${userLimits.maxRows} –∑–∞–ø–∏—Å–µ–π –¥–ª—è —Ä–æ–ª–∏ ${userRole}`
        });
    }

    if (userLimits.maxDaysRange && date_from && date_to) {
        const fromDate = new Date(date_from);
        const toDate = new Date(date_to);
        const daysDiff = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24));

        if (daysDiff > userLimits.maxDaysRange) {
            return res.status(400).json({
                error: `–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç. –ú–∞–∫—Å–∏–º—É–º ${userLimits.maxDaysRange} –¥–Ω–µ–π –¥–ª—è —Ä–æ–ª–∏ ${userRole}`
            });
        }
    }

    next();
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
function logExportAction(exportType) {
    return async (req, res, next) => {
        try {
            const logData = {
                userId: req.user?.id,
                username: req.user?.username,
                action: `export_${exportType}`,
                exportType: exportType,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
                timestamp: new Date(),
                filters: {
                    event_id: req.query.event_id,
                    status: req.query.status,
                    date_from: req.query.date_from,
                    date_to: req.query.date_to,
                    format: req.query.format
                }
            };

            if (process.env.NODE_ENV === 'development') {
                console.log('üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:', logData);
            }

            req.exportLog = logData;
            next();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', err);
            next();
        }
    };
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function logEditAction(req, res, next) {
    const originalSend = res.json;

    res.json = function(data) {
        // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (res.statusCode >= 200 && res.statusCode < 300) {
            const logData = {
                userId: req.user?.id,
                username: req.user?.username,
                action: 'edit_visitor',
                visitorId: req.params.id,
                ip: req.ip,
                userAgent: req.get('User-Agent'),
                timestamp: new Date(),
                changes: data.changes || {},
                method: req.method
            };

            if (process.env.NODE_ENV === 'development') {
                console.log('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', logData);
            }

            // –í production –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—É–¥–∏—Ç–∞
        }

        originalSend.call(this, data);
    };

    next();
}

// –≠–∫—Å–ø–æ—Ä—Ç—ã –º–æ–¥—É–ª—è
module.exports = {
    requireAuth,
    requireRole,
    requireScanAuth,
    logUserAction,
    canModifyVisitor,
    canBlockVisitor,
    canManageUsers,
    validateVisitorUUID,
    canEditVisitor,
    canModifyBarcode,
    checkEditLimits,
    canExportData,
    canExportScanStatistics,
    checkExportLimits,
    logExportAction,
    logEditAction
};