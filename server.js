const express = require('express');
const session = require('express-session');
const helmet = require('helmet');
const cors = require('cors');
const compression = require('compression');
const morgan = require('morgan');
const rateLimit = require('express-rate-limit');
const path = require('path');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const { initDB } = require('./config/database');
initDB().catch(console.error);

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¾Ðº
const uploadDir = process.env.UPLOAD_PATH || './uploads';
if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
}
if (!fs.existsSync(path.join(uploadDir, 'photos'))) {
    fs.mkdirSync(path.join(uploadDir, 'photos'), { recursive: true });
}
if (!fs.existsSync(path.join(uploadDir, 'qr-codes'))) {
    fs.mkdirSync(path.join(uploadDir, 'qr-codes'), { recursive: true });
}

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ CSP Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            scriptSrc: [
                "'self'",
                "'unsafe-inline'",
                "'unsafe-eval'",
                "https://cdnjs.cloudflare.com",
                "https://unpkg.com" // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð°ÑÐ½Ð¾Ð¹ CDN
            ],
            scriptSrcAttr: ["'unsafe-inline'"], // Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ onclick
            imgSrc: ["'self'", "data:", "blob:"],
            mediaSrc: ["'self'", "blob:"],
            connectSrc: ["'self'"],
            fontSrc: ["'self'"],
            objectSrc: ["'none'"],
            frameSrc: ["'none'"],
            baseUri: ["'self'"],
            formAction: ["'self'"],
        },
    },
    crossOriginEmbedderPolicy: false,
}));

// Rate limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 Ð¼Ð¸Ð½ÑƒÑ‚
    max: 100, // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð·Ð° Ð¾ÐºÐ½Ð¾
    message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ ÑÑ‚Ð¾Ð³Ð¾ IP'
});
app.use(limiter);

// Ð‘Ð¾Ð»ÐµÐµ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
const authLimiter = rateLimit({
    windowMs: 15 * 60 * 1000,
    max: 5, // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 5 Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð²Ñ…Ð¾Ð´Ð° Ð·Ð° 15 Ð¼Ð¸Ð½ÑƒÑ‚
    message: 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð²Ñ…Ð¾Ð´Ð°'
});

// Middleware
app.use(compression());
app.use(morgan('combined'));
app.use(cors({
    origin: process.env.FRONTEND_URL || true,
    credentials: true
}));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑÑÐ¸Ð¹
app.use(session({
    secret: process.env.SESSION_SECRET || 'your-secret-key-change-this',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: process.env.NODE_ENV === 'production',
        httpOnly: true,
        maxAge: 24 * 60 * 60 * 1000 // 24 Ñ‡Ð°ÑÐ°
    }
}));

// Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
app.use('/uploads', express.static(uploadDir));
app.use(express.static('public'));

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð²
const authRoutes = require('./routes/auth');
const visitorRoutes = require('./routes/visitors');
const scanRoutes = require('./routes/scan');
const adminRoutes = require('./routes/admin');

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ API
app.use('/api/auth', authLimiter, authRoutes);
app.use('/api/visitors', visitorRoutes);
app.use('/api/scan', scanRoutes);
app.use('/api/admin', adminRoutes);

// Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð´Ð»Ñ QR ÐºÐ¾Ð´Ð¾Ð²)
app.get('/scan/:uuid', async (req, res) => {
    const { uuid } = req.params;

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸ÑŽ
    if (!req.session.userId) {
        // ÐŸÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð¾Ð¼ Ð½Ð° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
        return res.redirect(`/login?return=/scan/${uuid}`);
    }

    res.sendFile(path.join(__dirname, 'public', 'scan.html'));
});

// Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
app.get('/login', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'login.html'));
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº 404
app.use((req, res) => {
    res.status(404).json({ error: 'Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°' });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
app.use((err, req, res, next) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°:', err);

    if (err.type === 'entity.too.large') {
        return res.status(413).json({ error: 'Ð¤Ð°Ð¹Ð» ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹' });
    }

    res.status(500).json({
        error: 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°',
        ...(process.env.NODE_ENV === 'development' && { details: err.message })
    });
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
    console.log(`ðŸ“Š Ð ÐµÐ¶Ð¸Ð¼: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ðŸ”’ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…: ${process.env.DB_HOST || 'localhost'}:${process.env.DB_PORT || 5432}`);
});

module.exports = app;