const express = require('express');
const session = require('express-session');
const helmet = require('helmet');
const cors = require('cors');
const compression = require('compression');
const morgan = require('morgan');
const rateLimit = require('express-rate-limit');
const path = require('path');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
const { initDB } = require('./config/database');
initDB().catch(console.error);

// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¾Ğº
const uploadDir = process.env.UPLOAD_PATH || './uploads';
if (!fs.existsSync(uploadDir)) {
    fs.mkdirSync(uploadDir, { recursive: true });
}
if (!fs.existsSync(path.join(uploadDir, 'photos'))) {
    fs.mkdirSync(path.join(uploadDir, 'photos'), { recursive: true });
}
if (!fs.existsSync(path.join(uploadDir, 'qr-codes'))) {
    fs.mkdirSync(path.join(uploadDir, 'qr-codes'), { recursive: true });
}

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ñ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ CSP Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ¹
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            scriptSrc: [
                "'self'",
                "'unsafe-inline'",
                "'unsafe-eval'",
                "https://cdnjs.cloudflare.com",
                "https://unpkg.com",
                "https://cdn.jsdelivr.net"
            ],
            scriptSrcAttr: ["'unsafe-inline'"],
            imgSrc: ["'self'", "data:", "blob:"],
            mediaSrc: ["'self'", "blob:"],
            connectSrc: ["'self'"],
            fontSrc: ["'self'"],
            objectSrc: ["'none'"],
            frameSrc: ["'none'"],
            baseUri: ["'self'"],
            formAction: ["'self'"],
        },
    },
    crossOriginEmbedderPolicy: false,
}));

// Ğ‘Ğ¾Ğ»ĞµĞµ Ğ¼ÑĞ³ĞºĞ¸Ğ¹ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ rate limiting
const generalLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    max: 1000, // 1000 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾ (Ğ±Ñ‹Ğ»Ğ¾ 100)
    message: { error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ IP' },
    standardHeaders: true,
    legacyHeaders: false,
    skip: (req) => {
        // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        return req.url.startsWith('/uploads/') ||
            req.url.startsWith('/favicon.ico');
    }
});
app.use(generalLimiter);

// Ğ‘Ğ¾Ğ»ĞµĞµ Ñ€Ğ°Ğ·ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
const authLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    max: 20, // 20 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ·Ğ° 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (Ğ±Ñ‹Ğ»Ğ¾ 5)
    message: { error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ²Ñ…Ğ¾Ğ´Ğ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚.' },
    standardHeaders: true,
    legacyHeaders: false,
    skipSuccessfulRequests: true, // ĞĞµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
    skipFailedRequests: false
});

// Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (Ğ±Ğ¾Ğ»ĞµĞµ Ğ¼ÑĞ³ĞºĞ¸Ğ¹)
const apiLimiter = rateLimit({
    windowMs: 1 * 60 * 1000, // 1 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°
    max: 60, // 60 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
    message: { error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²' },
    standardHeaders: true,
    legacyHeaders: false
});

// Middleware
app.use(compression());

// Ğ‘Ğ¾Ğ»ĞµĞµ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² development
if (process.env.NODE_ENV === 'development') {
    app.use(morgan('dev'));
} else {
    app.use(morgan('combined'));
}

app.use(cors({
    origin: process.env.FRONTEND_URL || true,
    credentials: true
}));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑĞµÑÑĞ¸Ğ¹ Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸
app.use(session({
    secret: process.env.SESSION_SECRET || 'your-secret-key-change-this',
    resave: false,
    saveUninitialized: false,
    name: 'visitor.sid', // ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ ÑĞµÑÑĞ¸Ğ¸
    cookie: {
        secure: process.env.NODE_ENV === 'production' && process.env.HTTPS === 'true',
        httpOnly: true,
        maxAge: 24 * 60 * 60 * 1000, // 24 Ñ‡Ğ°ÑĞ°
        sameSite: 'lax' // ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ñ CSRF Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ¾Ğ¹
    },
    rolling: true // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ€Ğ¾Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
}));

// Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
app.use('/uploads', express.static(uploadDir));
app.use(express.static('public'));

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ²
const authRoutes = require('./routes/auth');
const visitorRoutes = require('./routes/visitors');
const scanRoutes = require('./routes/scan');
const adminRoutes = require('./routes/admin');

// ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ API Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°Ğ¼Ğ¸
app.use('/api/auth', authLimiter, authRoutes);
app.use('/api/visitors', apiLimiter, visitorRoutes);
app.use('/api/scan', apiLimiter, scanRoutes);
app.use('/api/admin', apiLimiter, adminRoutes);

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ´Ğ»Ñ QR ĞºĞ¾Ğ´Ğ¾Ğ²)
app.get('/scan/:uuid', async (req, res) => {
    const { uuid } = req.params;

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    if (!req.session.userId) {
        // ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ¾Ğ¼ Ğ½Ğ° ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        return res.redirect(`/login?return=/scan/${uuid}`);
    }

    res.sendFile(path.join(__dirname, 'public', 'scan.html'));
});

// Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
app.get('/login', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'login.html'));
});

// Health check endpoint (Ğ±ĞµĞ· rate limiting)
app.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº 404
app.use((req, res) => {
    res.status(404).json({ error: 'Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°' });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
app.use((err, req, res, next) => {
    console.error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°:', err);

    // Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº rate limiting
    if (err.status === 429) {
        return res.status(429).json({
            error: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²',
            retryAfter: err.retryAfter
        });
    }

    if (err.type === 'entity.too.large') {
        return res.status(413).json({ error: 'Ğ¤Ğ°Ğ¹Ğ» ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹' });
    }

    // Ğ’ production Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
    const isDevelopment = process.env.NODE_ENV === 'development';

    res.status(500).json({
        error: 'Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°',
        ...(isDevelopment && {
            details: err.message,
            stack: err.stack
        })
    });
});

// Graceful shutdown
process.on('SIGTERM', () => {
    console.log('ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» SIGTERM, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('ğŸ›‘ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» SIGINT, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹...');
    process.exit(0);
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`ğŸš€ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
    console.log(`ğŸ“Š Ğ ĞµĞ¶Ğ¸Ğ¼: ${process.env.NODE_ENV || 'development'}`);
    console.log(`ğŸ”’ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ${process.env.DB_HOST || 'localhost'}:${process.env.DB_PORT || 5432}`);
    console.log(`ğŸŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ: http://localhost:${PORT}`);

    if (process.env.NODE_ENV !== 'production') {
        console.log('ğŸ” Ğ”ĞµĞ¼Ğ¾ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹:');
        console.log('   ğŸ‘‘ admin / admin123');
        console.log('   âš™ï¸ moderator / moderator123');
        console.log('   ğŸ”’ skd_user / skd123');
    }
});

module.exports = app;