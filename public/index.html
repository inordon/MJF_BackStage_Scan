// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

// –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function showCreateUserForm() {
document.getElementById('create-user-form').classList.remove('hidden');
document.getElementById('new-username').focus();
}

// –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function hideCreateUserForm() {
document.getElementById('create-user-form').classList.add('hidden');
document.getElementById('user-creation-form').reset();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function createUser(form) {
const formData = new FormData(form);
const submitBtn = form.querySelector('button[type="submit"]');

submitBtn.disabled = true;
submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

try {
const userData = {
username: formData.get('username'),
password: formData.get('password'),
role: formData.get('role'),
fullName: formData.get('fullName'),
email: formData.get('email') || null
};

const response = await fetch('/api/admin/users', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(userData)
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
}

showAlert('success', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.user.username} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`);
hideCreateUserForm();
loadAdminPanel(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
} catch (err) {
console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
showAlert('error', err.message);
} finally {
submitBtn.disabled = false;
submitBtn.innerHTML = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
}
}

// –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
function showPasswordResetForm(userId, fullName) {
document.getElementById('reset-user-id').value = userId;
document.getElementById('reset-password-form').classList.remove('hidden');
document.querySelector('#reset-password-form h4').textContent = `–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è: ${fullName}`;
document.getElementById('reset-new-password').focus();
}

// –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
function hidePasswordResetForm() {
document.getElementById('reset-password-form').classList.add('hidden');
document.getElementById('password-reset-form').reset();
}

// –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function resetUserPassword(form) {
const formData = new FormData(form);
const userId = document.getElementById('reset-user-id').value;
const newPassword = formData.get('newPassword');
const confirmPassword = document.getElementById('reset-confirm-password').value;

if (newPassword !== confirmPassword) {
showAlert('error', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
return;
}

const submitBtn = form.querySelector('button[type="submit"]');
submitBtn.disabled = true;
submitBtn.innerHTML = '<span class="loading"></span> –°–±—Ä–æ—Å...';

try {
const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({ newPassword })
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
}

showAlert('success', data.message);
hidePasswordResetForm();
loadAdminPanel(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
} catch (err) {
console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:', err);
showAlert('error', err.message);
} finally {
submitBtn.disabled = false;
submitBtn.innerHTML = 'üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
}
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function toggleUserStatus(userId, isActive, fullName) {
const newStatus = !isActive;
const action = newStatus ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${fullName}"?`)) {
return;
}

try {
const response = await fetch(`/api/admin/users/${userId}`, {
method: 'PUT',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({ isActive: newStatus })
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
}

showAlert('success', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${fullName}" ${newStatus ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`);
loadAdminPanel();
} catch (err) {
console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
showAlert('error', err.message);
}
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function deleteUser(userId, fullName) {
if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${fullName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
return;
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
const confirmation = prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨":`);
if (confirmation !== '–£–î–ê–õ–ò–¢–¨') {
showAlert('info', '–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
return;
}

try {
const response = await fetch(`/api/admin/users/${userId}`, {
method: 'DELETE'
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
}

showAlert('success', data.message);
loadAdminPanel();
} catch (err) {
console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
showAlert('error', err.message);
}
}

// –ü–æ–∫–∞–∑ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function showUserSessions(userId, username) {
try {
const response = await fetch(`/api/admin/users/${userId}/sessions`);
const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π');
}

let sessionsHtml = `
<div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; margin-top: 20px;">
    <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}</h4>
    `;

    if (data.sessions.length === 0) {
    sessionsHtml += '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>';
    } else {
    sessionsHtml += `
    <div style="margin-top: 15px;">
        ${data.sessions.map(session => `
        <div class="visitor-card" style="margin-bottom: 10px;">
            <div class="visitor-info">
                <div><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${new Date(session.createdAt).toLocaleString('ru-RU')}</div>
                <div><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> ${new Date(session.expiresAt).toLocaleString('ru-RU')}</div>
                <div><strong>IP –∞–¥—Ä–µ—Å:</strong> ${session.ipAddress}</div>
                <div><strong>–ë—Ä–∞—É–∑–µ—Ä:</strong> ${session.userAgent.substring(0, 100)}...</div>
                ${session.isCurrent ? '<div style="color: #28a745; font-weight: bold;">üü¢ –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</div>' : ''}
            </div>
            ${!session.isCurrent ? `
            <div class="visitor-actions">
                <button onclick="terminateSession('${session.id}', '${username}')" class="btn-danger">üîå –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            </div>
            ` : ''}
        </div>
        `).join('')}
    </div>
    `;
    }

    sessionsHtml += `
    <div style="margin-top: 15px;">
        <button onclick="closeSessions()" class="btn-secondary">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
        <button onclick="terminateAllUserSessions(${userId}, '${username}')" class="btn-danger">üö™ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏</button>
    </div>
</div>
`;

// –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å–µ—Å—Å–∏–π –≤ DOM
let sessionsContainer = document.getElementById('user-sessions-container');
if (!sessionsContainer) {
sessionsContainer = document.createElement('div');
sessionsContainer.id = 'user-sessions-container';
document.getElementById('users-management').appendChild(sessionsContainer);
}
sessionsContainer.innerHTML = sessionsHtml;

} catch (err) {
console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π:', err);
showAlert('error', '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏—è—Ö');
}
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏
async function terminateSession(sessionId, username) {
if (!confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
return;
}

try {
const response = await fetch(`/api/auth/sessions/${sessionId}`, {
method: 'DELETE'
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏');
}

showAlert('success', '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö
const userId = document.getElementById('reset-user-id').value;
showUserSessions(userId, username);
} catch (err) {
console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', err);
showAlert('error', err.message);
}
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function terminateAllUserSessions(userId, username) {
if (!confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å –í–°–ï —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω –æ—Ç –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.`)) {
return;
}

try {
const response = await fetch(`/api/admin/users/${userId}/terminate-sessions`, {
method: 'POST'
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–π');
}

showAlert('success', `–í—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username} –∑–∞–≤–µ—Ä—à–µ–Ω—ã`);
closeSessions();
loadAdminPanel();
} catch (err) {
console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–π:', err);
showAlert('error', err.message);
}
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –±–ª–æ–∫–∞ —Å–µ—Å—Å–∏–π
function closeSessions() {
const container = document.getElementById('user-sessions-container');
if (container) {
container.remove();
}
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function loadSystemStats() {
const container = document.getElementById('system-stats');
const content = document.getElementById('system-stats-content');

container.classList.remove('hidden');
content.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

try {
const response = await fetch('/api/admin/stats');
const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
}

content.innerHTML = `
<div class="stats-grid">
    <div class="detail-item">
        <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
        <div class="detail-value">${data.database.active_visitors}</div>
    </div>
    <div class="detail-item">
        <div class="detail-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
        <div class="detail-value">${data.database.blocked_visitors}</div>
    </div>
    <div class="detail-item">
        <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="detail-value">${data.database.active_users}</div>
    </div>
    <div class="detail-item">
        <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</div>
        <div class="detail-value">${data.database.active_sessions}</div>
    </div>
    <div class="detail-item">
        <div class="detail-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
        <div class="detail-value">${data.database.today_scans}</div>
    </div>
    <div class="detail-item">
        <div class="detail-label">–ò–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é</div>
        <div class="detail-value">${data.additional.recent_changes || 0}</div>
    </div>
</div>
<div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 8px;">
    <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${new Date(data.timestamp).toLocaleString('ru-RU')}
</div>
`;
} catch (err) {
console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
content.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
}
}

// –ü–æ–∫–∞–∑ –æ–ø—Ü–∏–π –æ—á–∏—Å—Ç–∫–∏
function showCleanupOptions() {
const options = [
{ value: 'expired_sessions', label: '–ò—Å—Ç–µ–∫—à–∏–µ —Å–µ—Å—Å–∏–∏' },
{ value: 'old_scans', label: '–°—Ç–∞—Ä—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (>90 –¥–Ω–µ–π)' },
{ value: 'old_history', label: '–°—Ç–∞—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (>365 –¥–Ω–µ–π)' },
{ value: 'all', label: '–í—Å–µ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ' }
];

const optionsHtml = options.map(opt =>
`<button onclick="performCleanup('${opt.value}')" class="btn-secondary" style="margin: 5px; width: 100%;">${opt.label}</button>`
).join('');

if (confirm('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:\n\n' + options.map(opt => `- ${opt.label}`).join('\n'))) {
const cleanupContainer = document.createElement('div');
cleanupContainer.innerHTML = `
<div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                background: white; padding: 30px; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                                z-index: 1000; min-width: 300px;">
    <h4 style="margin-bottom: 20px;">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
    <div style="margin-bottom: 20px;">
        ${optionsHtml}
    </div>
    <button onclick="this.parentElement.parentElement.remove()" class="btn-danger" style="width: 100%;">‚ùå –û—Ç–º–µ–Ω–∞</button>
</div>
<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"
     onclick="this.parentElement.remove()"></div>
`;
document.body.appendChild(cleanupContainer);
}
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏
async function performCleanup(cleanupType) {
if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É?\n\n–¢–∏–ø: ${cleanupType}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
return;
}

try {
const response = await fetch('/api/admin/cleanup', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({ cleanupType })
});

const data = await response.json();

if (!response.ok) {
throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
}

const results = Object.entries(data.cleaned).map(([key, count]) => `${key}: ${count} –∑–∞–ø–∏—Å–µ–π`).join('\n');
showAlert('success', `–û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:\n${results}`);

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
const modal = document.querySelector('div[style*="position: fixed"]')?.parentElement;
if (modal) modal.remove();

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
loadSystemStats();
} catch (err) {
console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', err);
showAlert('error', err.message);
}
}<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: #333;
            font-size: 2.2em;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .tab-container {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 6px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #dc3545;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            margin-left: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .visitor-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .visitor-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .visitor-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-blocked {
            background: #f8d7da;
            color: #721c24;
        }

        .visitor-info {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .visitor-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visitor-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        #qr-video {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none !important;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .visitor-actions {
                flex-direction: column;
            }

            .tab-container {
                flex-wrap: wrap;
            }

            .tab {
                flex: none;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" onclick="showTab('visitors')" id="tab-visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" onclick="showTab('add-visitor')" id="tab-add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" onclick="showTab('scanner')" id="tab-scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" onclick="showTab('stats')" id="tab-stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" onclick="showTab('admin')" id="tab-admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π -->
    <div id="visitors" class="content active">
        <div class="form-row" style="margin-bottom: 20px;">
            <div class="form-group">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É..." onkeyup="searchVisitors()">
            </div>
            <div class="form-group">
                <select id="status-filter" onchange="filterVisitors()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                </select>
            </div>
        </div>

        <div id="visitors-list"></div>
        <div id="visitors-pagination" class="pagination"></div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label for="last-name">–§–∞–º–∏–ª–∏—è <span class="required">*</span></label>
                    <input type="text" id="last-name" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="first-name">–ò–º—è <span class="required">*</span></label>
                    <input type="text" id="first-name" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="middle-name">–û—Ç—á–µ—Å—Ç–≤–æ <span class="required">*</span></label>
                    <input type="text" id="middle-name" name="middleName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="birth-date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="birth-date" name="birthDate">
                </div>
                <div class="form-group">
                    <label for="responsible">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π <span class="required">*</span></label>
                    <input type="text" id="responsible" name="responsible" required>
                </div>
            </div>

            <div class="form-group">
                <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            </div>

            <div class="form-group">
                <label for="visitor-photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                <input type="file" id="visitor-photo" name="photo" accept="image/*" onchange="previewPhoto()">
                <img id="photo-preview" class="photo-preview hidden" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            </div>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥</button>
        </form>

        <div id="visitor-result" class="hidden">
            <div class="qr-container">
                <div id="qrcode"></div>
                <p style="margin-top: 15px; font-weight: 600;">QR-–∫–æ–¥ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</p>
                <button onclick="downloadQR()" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å QR</button>
                <button onclick="resetForm()" class="btn-secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
            </div>
        </div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <div class="scanner-container">
            <video id="qr-video" class="hidden"></video>
        </div>
        <button onclick="startScanner()" id="start-scanner-btn">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button onclick="stopScanner()" class="hidden" id="stop-scanner-btn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div id="scan-result" class="hidden">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="scan-info"></div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div class="stats-grid" id="stats-overview"></div>
        <div id="recent-activity"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        <div id="users-management"></div>
    </div>
</div>

<script>
    let currentUser = null;
    let visitors = [];
    let currentPage = 1;
    let totalPages = 1;
    let qrScanner = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        await loadVisitors();
        await loadStats();
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check');
            const data = await response.json();

            if (!data.authenticated) {
                window.location.href = '/login';
                return;
            }

            currentUser = data.user;
            updateUserInterface();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
            window.location.href = '/login';
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUserInterface() {
        document.getElementById('user-badge').textContent =
            `${currentUser.fullName} (${getRoleText(currentUser.role)})`;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫
        const tabAddVisitor = document.getElementById('tab-add-visitor');
        const tabAdmin = document.getElementById('tab-admin');

        if (currentUser.role === 'skd') {
            // –°–ö–î —Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            tabAddVisitor.disabled = true;
            document.getElementById('tab-visitors').disabled = true;
            document.getElementById('tab-stats').disabled = true;
            showTab('scanner');
        } else if (currentUser.role === 'admin') {
            // –ê–¥–º–∏–Ω - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
            tabAdmin.disabled = false;
        }
    }

    function getRoleText(role) {
        const roles = {
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
            'skd': '–°–ö–î'
        };
        return roles[role] || role;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
        if (tabName === 'visitors') {
            loadVisitors();
        } else if (tabName === 'stats') {
            loadStats();
        } else if (tabName === 'admin') {
            loadAdminPanel();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    async function loadVisitors(page = 1) {
        try {
            const search = document.getElementById('search-input')?.value || '';
            const status = document.getElementById('status-filter')?.value || '';

            const params = new URLSearchParams({
                page: page,
                limit: 10,
                ...(search && { search }),
                ...(status && { status })
            });

            const response = await fetch(`/api/visitors?${params}`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            visitors = data.visitors;
            currentPage = data.pagination.page;
            totalPages = data.pagination.pages;

            renderVisitors();
            renderPagination();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function renderVisitors() {
        const container = document.getElementById('visitors-list');

        if (visitors.length === 0) {
            container.innerHTML = '<div class="alert alert-info">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        container.innerHTML = visitors.map(visitor => `
                <div class="visitor-card">
                    <div class="visitor-header">
                        <div class="visitor-name">${visitor.last_name} ${visitor.first_name} ${visitor.middle_name}</div>
                        <div class="status-badge status-${visitor.status}">
                            ${visitor.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                        </div>
                    </div>
                    <div class="visitor-info">
                        <div><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${visitor.responsible}</div>
                        ${visitor.birth_date ? `<div><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> ${new Date(visitor.birth_date).toLocaleDateString('ru-RU')}</div>` : ''}
                        ${visitor.comment ? `<div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${visitor.comment}</div>` : ''}
                        <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(visitor.created_at).toLocaleString('ru-RU')} (${visitor.created_by_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'})</div>
                        <div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:</strong> ${visitor.total_scans} (—Å–µ–≥–æ–¥–Ω—è: ${visitor.first_scan_today ? '1+' : '0'})</div>
                    </div>
                    <div class="visitor-actions">
                        <button onclick="downloadVisitorQR(${visitor.id})" class="btn-secondary">üì• QR-–∫–æ–¥</button>
                        <button onclick="toggleVisitorStatus(${visitor.id}, '${visitor.status}')"
                                class="${visitor.status === 'active' ? 'btn-danger' : 'btn-success'}">
                            ${visitor.status === 'active' ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                        </button>
                        <button onclick="editVisitor(${visitor.id})" class="btn-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        ${currentUser.role === 'admin' ? `<button onclick="deleteVisitor(${visitor.id})" class="btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                    </div>
                </div>
            `).join('');
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function renderPagination() {
        const container = document.getElementById('visitors-pagination');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        if (currentPage > 1) {
            html += `<button onclick="loadVisitors(${currentPage - 1})">‚Üê –ù–∞–∑–∞–¥</button>`;
        }

        html += `<span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}</span>`;

        if (currentPage < totalPages) {
            html += `<button onclick="loadVisitors(${currentPage + 1})">–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
        }

        container.innerHTML = html;
    }

    // –ü–æ–∏—Å–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function searchVisitors() {
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => {
            loadVisitors(1);
        }, 500);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function filterVisitors() {
        loadVisitors(1);
    }

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
    function previewPhoto() {
        const file = document.getElementById('visitor-photo').files[0];
        const preview = document.getElementById('photo-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            preview.classList.add('hidden');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    document.getElementById('visitor-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const submitBtn = e.target.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const response = await fetch('/api/visitors', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const qrUrl = `${window.location.origin}/scan/${data.visitor.visitor_uuid}`;

            document.getElementById('qrcode').innerHTML = '';
            QRCode.toCanvas(document.getElementById('qrcode'), qrUrl, {
                width: 200,
                margin: 2
            });

            document.getElementById('visitor-result').classList.remove('hidden');
            document.getElementById('visitor-form').style.display = 'none';

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥';
        }
    });

    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    function resetForm() {
        document.getElementById('visitor-form').reset();
        document.getElementById('photo-preview').classList.add('hidden');
        document.getElementById('visitor-result').classList.add('hidden');
        document.getElementById('visitor-form').style.display = 'block';
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
    function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'visitor-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function downloadVisitorQR(visitorId) {
        try {
            const response = await fetch(`/api/visitors/${visitorId}/qr`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `visitor-qr-${visitorId}.png`;
            link.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞');
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function toggleVisitorStatus(visitorId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
        const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', data.message);
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
    function startScanner() {
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        qrScanner = new QrScanner(video, result => {
            handleScanResult(result.data);
        }, {
            returnDetailedScanResult: true,
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        qrScanner.start().then(() => {
            video.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
            showAlert('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        });
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    function stopScanner() {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
            qrScanner = null;
        }

        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        video.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    async function handleScanResult(qrData) {
        try {
            let uuid = null;

            // –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∏–∑ QR –∫–æ–¥–∞
            if (qrData.includes('/scan/')) {
                uuid = qrData.split('/scan/')[1];
            } else if (qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)) {
                uuid = qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)[0];
            }

            if (!uuid) {
                showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            const response = await fetch(`/api/scan/check/${uuid}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            displayScanResult(data);
            stopScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞');
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function displayScanResult(data) {
        const container = document.getElementById('scan-info');

        if (!data.found) {
            container.innerHTML = `
                    <div class="alert alert-error">
                        <h4>‚ùå –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</h4>
                        <p>QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</p>
                    </div>
                `;
        } else {
            const visitor = data.visitor;
            const stats = data.scanStats;

            const alertClass = stats.isFirstScanToday ? 'alert-success' : 'alert-info';
            const icon = stats.isFirstScanToday ? '‚úÖ' : '‚ö†Ô∏è';
            const message = stats.isFirstScanToday ? '–ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å' : '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';

            container.innerHTML = `
                    <div class="alert ${alertClass}">
                        <h4>${icon} ${visitor.fullName}</h4>
                        ${visitor.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${visitor.comment}</p>` : ''}
                        <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> ${visitor.responsible}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${message}</p>
                        ${!stats.isFirstScanToday ? `<p><strong>–ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${new Date(stats.firstScanToday).toLocaleString('ru-RU')}</p>` : ''}
                        <p><strong>–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:</strong> ${stats.totalScans}</p>
                    </div>
                `;
        }

        document.getElementById('scan-result').classList.remove('hidden');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStats() {
        try {
            const response = await fetch('/api/visitors/stats/overview');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderStats(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderStats(data) {
        const overview = document.getElementById('stats-overview');
        const activity = document.getElementById('recent-activity');

        // –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        overview.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.visitors.total_visitors}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.visitors.active_visitors}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans.today_scans}</div>
                    <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans.week_scans}</div>
                    <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
            `;

        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (data.recentActivity && data.recentActivity.length > 0) {
            activity.innerHTML = `
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                    <div class="visitor-list">
                        ${data.recentActivity.map(scan => `
                            <div class="visitor-card">
                                <div class="visitor-header">
                                    <div class="visitor-name">${scan.last_name} ${scan.first_name} ${scan.middle_name}</div>
                                    <div class="status-badge status-${scan.scan_type === 'first' ? 'active' : 'blocked'}">
                                        ${scan.scan_type === 'first' ? '–ü–µ—Ä–≤–æ–µ' : '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ'}
                                    </div>
                                </div>
                                <div class="visitor-info">
                                    <div><strong>–í—Ä–µ–º—è:</strong> ${new Date(scan.scanned_at).toLocaleString('ru-RU')}</div>
                                    ${scan.scanned_by_name ? `<div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–ª:</strong> ${scan.scanned_by_name}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
        } else {
            activity.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    async function loadAdminPanel() {
        if (currentUser.role !== 'admin') {
            return;
        }

        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderAdminPanel(data.users);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    function renderAdminPanel(users) {
        const container = document.getElementById('users-management');

        container.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button onclick="showCreateUserForm()" class="btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                    <button onclick="loadSystemStats()" class="btn-secondary">üìä –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    <button onclick="showCleanupOptions()" class="btn-secondary">üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</button>
                </div>

                <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div id="create-user-form" class="hidden" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 20px;">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                    <form id="user-creation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-username">–õ–æ–≥–∏–Ω <span class="required">*</span></label>
                                <input type="text" id="new-username" name="username" required
                                       pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ">
                            </div>
                            <div class="form-group">
                                <label for="new-password">–ü–∞—Ä–æ–ª—å <span class="required">*</span></label>
                                <input type="password" id="new-password" name="password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="new-role">–†–æ–ª—å <span class="required">*</span></label>
                                <select id="new-role" name="role" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                    <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                                    <option value="skd">–°–ö–î</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-fullname">–§–ò–û <span class="required">*</span></label>
                                <input type="text" id="new-fullname" name="fullName" required>
                            </div>
                            <div class="form-group">
                                <label for="new-email">Email</label>
                                <input type="email" id="new-email" name="email">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit">‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                            <button type="button" onclick="hideCreateUserForm()" class="btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>

                <!-- –§–æ—Ä–º–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è -->
                <div id="reset-password-form" class="hidden" style="margin-bottom: 30px; padding: 20px; background: #fff3cd; border-radius: 12px; border: 2px solid #ffeaa7;">
                    <h4 style="margin-bottom: 20px;">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                    <form id="password-reset-form">
                        <input type="hidden" id="reset-user-id">
                        <div class="form-group">
                            <label for="reset-new-password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å <span class="required">*</span></label>
                            <input type="password" id="reset-new-password" name="newPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="reset-confirm-password">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è <span class="required">*</span></label>
                            <input type="password" id="reset-confirm-password" required minlength="6">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit">üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                            <button type="button" onclick="hidePasswordResetForm()" class="btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div id="users-list">
                    ${users.map(user => `
                        <div class="visitor-card">
                            <div class="visitor-header">
                                <div class="visitor-name">${user.fullName} (${user.username})</div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <div class="status-badge status-${user.isActive ? 'active' : 'blocked'}">
                                        ${getRoleText(user.role)}
                                    </div>
                                    ${!user.isActive ? '<div class="status-badge status-blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>' : ''}
                                    ${user.id === currentUser.id ? '<div class="status-badge" style="background: #d1ecf1; color: #0c5460;">–≠—Ç–æ –≤—ã</div>' : ''}
                                </div>
                            </div>
                            <div class="visitor-info">
                                <div><strong>Email:</strong> ${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(user.createdAt).toLocaleString('ru-RU')}</div>
                                <div><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${new Date(user.updatedAt).toLocaleString('ru-RU')}</div>
                                <div><strong>–°–æ–∑–¥–∞–ª:</strong> ${user.createdByName || '–°–∏—Å—Ç–µ–º–∞'}</div>
                                <div><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π:</strong> ${user.activeSessions}</div>
                            </div>
                            <div class="visitor-actions">
                                <button onclick="showUserSessions(${user.id}, '${user.username}')" class="btn-secondary">üì± –°–µ—Å—Å–∏–∏</button>
                                <button onclick="showPasswordResetForm(${user.id}, '${user.fullName}')" class="btn-secondary">üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                                <button onclick="toggleUserStatus(${user.id}, ${user.isActive}, '${user.fullName}')"
                                        class="${user.isActive ? 'btn-danger' : 'btn-success'}"
                                        ${user.id === currentUser.id ? 'disabled title="–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞"' : ''}>
                                    ${user.isActive ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                                </button>
                                ${user.id !== currentUser.id ? `<button onclick="deleteUser(${user.id}, '${user.fullName}')" class="btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div id="system-stats" class="hidden" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                    <h4>–°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div id="system-stats-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
        setupAdminFormHandlers();
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ñ–æ—Ä–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    function setupAdminFormHandlers() {
        // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('user-creation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await createUser(e.target);
        });

        // –§–æ—Ä–º–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
        document.getElementById('password-reset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await resetUserPassword(e.target);
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
        document.getElementById('reset-confirm-password').addEventListener('input', (e) => {
            const password = document.getElementById('reset-new-password').value;
            const confirm = e.target.value;

            if (password !== confirm) {
                e.target.setCustomValidity('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            } else {
                e.target.setCustomValidity('');
            }
        });
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.tab-container'));

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
        } finally {
            window.location.href = '/login';
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏-–∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤—ã—à–µ)
    function editVisitor(id) {
        showAlert('info', '–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    }

    function deleteVisitor(id) {
        showAlert('info', '–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ API');
    }

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

    // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function showCreateUserForm() {
        document.getElementById('create-user-form').classList.remove('hidden');
        document.getElementById('new-username').focus();
    }

    // –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function hideCreateUserForm() {
        document.getElementById('create-user-form').classList.add('hidden');
        document.getElementById('user-creation-form').reset();
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function createUser(form) {
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                fullName: formData.get('fullName'),
                email: formData.get('email') || null
            };

            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }

            showAlert('success', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.user.username} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`);
            hideCreateUserForm();
            loadAdminPanel(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
            showAlert('error', err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '‚úÖ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        }
    }

    // –ü–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
    function showPasswordResetForm(userId, fullName) {
        document.getElementById('reset-user-id').value = userId;
        document.getElementById('reset-password-form').classList.remove('hidden');
        document.querySelector('#reset-password-form h4').textContent = `–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è: ${fullName}`;
        document.getElementById('reset-new-password').focus();
    }

    // –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
    function hidePasswordResetForm() {
        document.getElementById('reset-password-form').classList.add('hidden');
        document.getElementById('password-reset-form').reset();
    }

    // –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function resetUserPassword(form) {
        const formData = new FormData(form);
        const userId = document.getElementById('reset-user-id').value;
        const newPassword = formData.get('newPassword');
        const confirmPassword = document.getElementById('reset-confirm-password').value;

        if (newPassword !== confirmPassword) {
            showAlert('error', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> –°–±—Ä–æ—Å...';

        try {
            const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newPassword })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
            }

            showAlert('success', data.message);
            hidePasswordResetForm();
            loadAdminPanel(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:', err);
            showAlert('error', err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å';
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function toggleUserStatus(userId, isActive, fullName) {
        const newStatus = !isActive;
        const action = newStatus ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${fullName}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ isActive: newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }

            showAlert('success', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${fullName}" ${newStatus ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`);
            loadAdminPanel();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
            showAlert('error', err.message);
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function deleteUser(userId, fullName) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${fullName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
            return;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        const confirmation = prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "–£–î–ê–õ–ò–¢–¨":`);
        if (confirmation !== '–£–î–ê–õ–ò–¢–¨') {
            showAlert('info', '–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            return;
        }

        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }

            showAlert('success', data.message);
            loadAdminPanel();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
            showAlert('error', err.message);
        }
    }

    // –ü–æ–∫–∞–∑ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function showUserSessions(userId, username) {
        try {
            const response = await fetch(`/api/auth/sessions`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π');
            }

            let sessionsHtml = `
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; margin-top: 20px;">
                        <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}</h4>
                `;

            if (data.sessions.length === 0) {
                sessionsHtml += '<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>';
            } else {
                sessionsHtml += `
                        <div style="margin-top: 15px;">
                            ${data.sessions.map(session => `
                                <div class="visitor-card" style="margin-bottom: 10px;">
                                    <div class="visitor-info">
                                        <div><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> ${new Date(session.createdAt).toLocaleString('ru-RU')}</div>
                                        <div><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> ${new Date(session.expiresAt).toLocaleString('ru-RU')}</div>
                                        <div><strong>IP –∞–¥—Ä–µ—Å:</strong> ${session.ipAddress}</div>
                                        <div><strong>–ë—Ä–∞—É–∑–µ—Ä:</strong> ${session.userAgent ? session.userAgent.substring(0, 100) + '...' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                                        ${session.isCurrent ? '<div style="color: #28a745; font-weight: bold;">üü¢ –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</div>' : ''}
                                    </div>
                                    ${!session.isCurrent ? `
                                        <div class="visitor-actions">
                                            <button onclick="terminateSession('${session.id}', '${username}')" class="btn-danger">üîå –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
            }

            sessionsHtml += `
                    <div style="margin-top: 15px;">
                        <button onclick="closeSessions()" class="btn-secondary">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    </div>
                `;

            // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å–µ—Å—Å–∏–π –≤ DOM
            let sessionsContainer = document.getElementById('user-sessions-container');
            if (!sessionsContainer) {
                sessionsContainer = document.createElement('div');
                sessionsContainer.id = 'user-sessions-container';
                document.getElementById('users-management').appendChild(sessionsContainer);
            }
            sessionsContainer.innerHTML = sessionsHtml;

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–π:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏—è—Ö');
        }
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏
    async function terminateSession(sessionId, username) {
        if (!confirm(`–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/auth/sessions/${sessionId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏');
            }

            showAlert('success', '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏—è—Ö
            showUserSessions(null, username);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', err);
            showAlert('error', err.message);
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –±–ª–æ–∫–∞ —Å–µ—Å—Å–∏–π
    function closeSessions() {
        const container = document.getElementById('user-sessions-container');
        if (container) {
            container.remove();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadSystemStats() {
        const container = document.getElementById('system-stats');
        const content = document.getElementById('system-stats-content');

        container.classList.remove('hidden');
        content.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const response = await fetch('/api/admin/stats');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }

            content.innerHTML = `
                    <div class="stats-grid">
                        <div class="detail-item">
                            <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
                            <div class="detail-value">${data.database.active_visitors}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
                            <div class="detail-value">${data.database.blocked_visitors}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                            <div class="detail-value">${data.database.active_users}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</div>
                            <div class="detail-value">${data.database.active_sessions}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                            <div class="detail-value">${data.database.today_scans}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–ò–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                            <div class="detail-value">${data.additional.recent_changes || 0}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 8px;">
                        <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong> ${new Date(data.timestamp).toLocaleString('ru-RU')}
                    </div>
                `;
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            content.innerHTML = '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
        }
    }

    // –ü–æ–∫–∞–∑ –æ–ø—Ü–∏–π –æ—á–∏—Å—Ç–∫–∏
    function showCleanupOptions() {
        const options = [
            { value: 'expired_sessions', label: '–ò—Å—Ç–µ–∫—à–∏–µ —Å–µ—Å—Å–∏–∏' },
            { value: 'old_scans', label: '–°—Ç–∞—Ä—ã–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (>90 –¥–Ω–µ–π)' },
            { value: 'old_history', label: '–°—Ç–∞—Ä–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (>365 –¥–Ω–µ–π)' },
            { value: 'all', label: '–í—Å–µ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ' }
        ];

        const optionsHtml = options.map(opt =>
            `<button onclick="performCleanup('${opt.value}')" class="btn-secondary" style="margin: 5px; width: 100%;">${opt.label}</button>`
        ).join('');

        const cleanupContainer = document.createElement('div');
        cleanupContainer.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: white; padding: 30px; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                            z-index: 1000; min-width: 300px;">
                    <h4 style="margin-bottom: 20px;">–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h4>
                    <div style="margin-bottom: 20px;">
                        ${optionsHtml}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn-danger" style="width: 100%;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"
                     onclick="this.parentElement.remove()"></div>
            `;
        document.body.appendChild(cleanupContainer);
    }

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏
    async function performCleanup(cleanupType) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É?\n\n–¢–∏–ø: ${cleanupType}\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
            return;
        }

        try {
            const response = await fetch('/api/admin/cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cleanupType })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏');
            }

            const results = Object.entries(data.cleaned).map(([key, count]) => `${key}: ${count} –∑–∞–ø–∏—Å–µ–π`).join('\n');
            showAlert('success', `–û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:\n${results}`);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.querySelector('div[style*="position: fixed"]')?.parentElement;
            if (modal) modal.remove();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadSystemStats();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', err);
            showAlert('error', err.message);
        }
    }
</script>
</body>
</html>