<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è QR –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script>
        window.SimpleQR = {
            toCanvas: function(canvas, text, options = {}) {
                return new Promise((resolve, reject) => {
                    try {
                        const ctx = canvas.getContext('2d');
                        const size = options.width || 200;
                        canvas.width = size;
                        canvas.height = size;

                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, size, size);
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(10, 10, size-20, size-20);

                        ctx.fillStyle = '#000000';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', size/2, size/2 - 20);
                        ctx.fillText('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', size/2, size/2);

                        const maxWidth = size - 40;
                        const words = text.replace(/https?:\/\//, '').split('/');
                        let line = '';
                        let y = size/2 + 20;

                        ctx.font = '10px Arial';
                        for (let i = 0; i < words.length && y < size - 20; i++) {
                            const testLine = line + words[i] + '/';
                            const metrics = ctx.measureText(testLine);

                            if (metrics.width > maxWidth && i > 0) {
                                ctx.fillText(line, size/2, y);
                                line = words[i] + '/';
                                y += 12;
                            } else {
                                line = testLine;
                            }
                        }
                        if (y < size - 20) {
                            ctx.fillText(line, size/2, y);
                        }

                        resolve(canvas);
                    } catch (err) {
                        reject(err);
                    }
                });
            }
        };

        async function loadQRLibraries() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ QR –±–∏–±–ª–∏–æ—Ç–µ–∫...');
            const qrSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js',
                'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js'
            ];

            for (const src of qrSources) {
                try {
                    await loadScript(src);
                    if (typeof QRCode !== 'undefined' || typeof qrcode !== 'undefined') {
                        console.log('‚úÖ QR –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å:', src);
                        window.QRCode = window.QRCode || window.qrcode;
                        return true;
                    }
                } catch (err) {
                    console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å QRCode —Å:', src, err.message);
                    continue;
                }
            }

            console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π QR –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä');
            window.QRCode = window.SimpleQR;
            return false;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                script.src = src;
                script.async = true;
                document.head.appendChild(script);

                setTimeout(() => {
                    reject(new Error('Timeout loading script'));
                }, 5000);
            });
        }

        async function loadQRScanner() {
            try {
                await loadScript('https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js');
                console.log('‚úÖ QR Scanner –∑–∞–≥—Ä—É–∂–µ–Ω');
                return true;
            } catch (err) {
                console.log('‚ö†Ô∏è QR Scanner –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return false;
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: #333;
            font-size: 2.2em;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .tab-container {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 6px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #dc3545;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            margin-left: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .visitor-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .visitor-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .visitor-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-blocked {
            background: #f8d7da;
            color: #721c24;
        }

        .event-badge {
            background: #e3f2fd;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .visitor-info {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .visitor-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visitor-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        #qr-video {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none !important;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .event-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .event-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .event-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
            line-height: 1.2;
        }

        .event-dates {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .event-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .event-stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .event-stat-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .event-stat-label {
            font-size: 12px;
            color: #666;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .visitor-actions {
                flex-direction: column;
            }

            .tab-container {
                flex-wrap: wrap;
            }

            .tab {
                flex: none;
                min-width: 120px;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" id="logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" id="tab-visitors" data-tab="visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" id="tab-add-visitor" data-tab="add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" id="tab-events" data-tab="events">üéØ –°–æ–±—ã—Ç–∏—è</button>
        <button class="tab" id="tab-scanner" data-tab="scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" id="tab-stats" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" id="tab-admin" data-tab="admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π -->
    <div id="visitors" class="content active">
        <div class="form-row" style="margin-bottom: 20px;">
            <div class="form-group">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, —Å–æ–±—ã—Ç–∏—é...">
            </div>
            <div class="form-group">
                <select id="status-filter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                </select>
            </div>
            <div class="form-group">
                <select id="event-filter">
                    <option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
                </select>
            </div>
        </div>

        <div id="visitors-list"></div>
        <div id="visitors-pagination" class="pagination"></div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="event-select">–°–æ–±—ã—Ç–∏–µ <span class="required">*</span></label>
                <select id="event-select" name="eventId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="last-name">–§–∞–º–∏–ª–∏—è <span class="required">*</span></label>
                    <input type="text" id="last-name" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="first-name">–ò–º—è <span class="required">*</span></label>
                    <input type="text" id="first-name" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="middle-name">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                    <input type="text" id="middle-name" name="middleName">
                </div>
            </div>

            <div class="form-group">
                <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            </div>

            <div class="form-group">
                <label for="visitor-photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                <input type="file" id="visitor-photo" name="photo" accept="image/*">
                <img id="photo-preview" class="photo-preview hidden" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            </div>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥</button>
        </form>

        <div id="visitor-result" class="hidden">
            <div class="qr-container">
                <div id="qrcode"></div>
                <p style="margin-top: 15px; font-weight: 600;">QR-–∫–æ–¥ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</p>
                <button type="button" id="download-qr-btn" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å QR</button>
                <button type="button" id="reset-form-btn" class="btn-secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
            </div>
        </div>
    </div>

    <!-- –°–æ–±—ã—Ç–∏—è -->
    <div id="events" class="content">
        <div style="margin-bottom: 20px;">
            <button id="create-event-btn" class="btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>

        <div id="events-list" class="events-grid"></div>
        <div id="events-pagination" class="pagination"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <div class="scanner-container">
            <video id="qr-video" class="hidden"></video>
        </div>
        <button id="start-scanner-btn">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button class="hidden" id="stop-scanner-btn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div id="scan-result" class="hidden">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="scan-info"></div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div class="stats-grid" id="stats-overview"></div>
        <div id="events-stats"></div>
        <div id="recent-activity"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        <div id="users-management"></div>
    </div>
</div>

<script>
    let currentUser = null;
    let visitors = [];
    let events = [];
    let activeEvents = [];
    let currentPage = 1;
    let totalPages = 1;
    let qrScanner = null;
    let searchTimeout = null;
    let qrLibraryLoaded = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
        console.clear();
        console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

        try {
            qrLibraryLoaded = await loadQRLibraries();
            await loadQRScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫:', err);
        }

        setupEventListeners();

        const isAuthenticated = await checkAuth();
        if (isAuthenticated) {
            console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            await Promise.all([
                loadActiveEvents(),
                loadVisitors(),
                loadStats(),
                loadEvents()
            ]);
            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                if (tabName) showTab(tabName);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
        document.getElementById('logout-btn').addEventListener('click', logout);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('search-input').addEventListener('keyup', searchVisitors);
        document.getElementById('status-filter').addEventListener('change', filterVisitors);
        document.getElementById('event-filter').addEventListener('change', filterVisitors);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        document.getElementById('visitor-form').addEventListener('submit', handleVisitorFormSubmit);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        document.getElementById('visitor-photo').addEventListener('change', previewPhoto);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ QR
        document.getElementById('download-qr-btn').addEventListener('click', downloadQR);
        document.getElementById('reset-form-btn').addEventListener('click', resetForm);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
        document.getElementById('start-scanner-btn').addEventListener('click', startScanner);
        document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        document.getElementById('create-event-btn').addEventListener('click', showCreateEventForm);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check');
            const data = await response.json();

            if (!data.authenticated) {
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                window.location.href = '/login';
                return false;
            }

            currentUser = data.user;
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.username);
            updateUserInterface();
            return true;
        } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
            window.location.href = '/login';
            return false;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUserInterface() {
        document.getElementById('user-badge').textContent =
            `${currentUser.fullName} (${getRoleText(currentUser.role)})`;

        const tabAddVisitor = document.getElementById('tab-add-visitor');
        const tabAdmin = document.getElementById('tab-admin');
        const tabVisitors = document.getElementById('tab-visitors');
        const tabStats = document.getElementById('tab-stats');
        const tabEvents = document.getElementById('tab-events');

        if (currentUser.role === 'skd') {
            // –°–ö–î —Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            tabAddVisitor.disabled = true;
            tabVisitors.disabled = true;
            tabStats.disabled = true;
            tabEvents.disabled = true;
            showTab('scanner');
        } else if (currentUser.role === 'admin') {
            // –ê–¥–º–∏–Ω - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
            tabAdmin.disabled = false;
        } else if (currentUser.role === 'moderator') {
            // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä - –≤—Å–µ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            tabEvents.disabled = false;
        }
    }

    function getRoleText(role) {
        const roles = {
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
            'skd': '–°–ö–î'
        };
        return roles[role] || role;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
        document.querySelectorAll('.content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        if (tabName === 'visitors') {
            loadVisitors();
        } else if (tabName === 'stats') {
            loadStats();
        } else if (tabName === 'admin') {
            loadAdminPanel();
        } else if (tabName === 'events') {
            loadEvents();
        } else if (tabName === 'add-visitor') {
            loadActiveEvents();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞
    async function loadActiveEvents() {
        try {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π...');

            const response = await fetch('/api/visitors/events/active', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å —Å–æ–±—ã—Ç–∏–π:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);

                if (response.status === 401) {
                    console.log('üîë –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ–≥–∏–Ω');
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 404) {
                    console.error('üîç –ú–∞—Ä—à—Ä—É—Ç /api/visitors/events/active –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    showAlert('error', '–ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω.');
                    return;
                }

                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            console.log('üìä –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏–π:', data);

            if (!data.events || !Array.isArray(data.events)) {
                console.error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', data);
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π');
            }

            activeEvents = data.events;
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${activeEvents.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π`);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
            updateEventSelectors();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if (activeEvents.length === 0) {
                showAlert('warning', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π. –°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–æ–±—ã—Ç–∏—è".');
            } else {
                console.log(`‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ ${activeEvents.length} —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞`);
            }

        } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', err);

            // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏
            if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            } else if (err.message.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                showAlert('error', '–§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω.');
            } else {
                showAlert('error', `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ${err.message}`);
            }

            // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫
            activeEvents = [];
            updateEventSelectors();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function updateEventSelectors() {
        const eventSelect = document.getElementById('event-select');
        const eventFilter = document.getElementById('event-filter');

        if (!eventSelect || !eventFilter) {
            console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ —Å–æ–±—ã—Ç–∏–π');
            return;
        }

        // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        eventSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>';

        // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
        eventFilter.innerHTML = '<option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>';

        if (activeEvents.length === 0) {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
            const noEventsOption = new Option('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π - —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ', '');
            noEventsOption.disabled = true;
            eventSelect.appendChild(noEventsOption);

            console.log('‚ö†Ô∏è –°–µ–ª–µ–∫—Ç–æ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã: –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π');
            return;
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã —Å–æ–±—ã—Ç–∏—è–º–∏
        activeEvents.forEach(event => {
            const startDate = new Date(event.start_date).toLocaleDateString('ru-RU');
            const endDate = new Date(event.end_date).toLocaleDateString('ru-RU');

            let optionText = event.name;
            if (startDate === endDate) {
                optionText += ` (${startDate})`;
            } else {
                optionText += ` (${startDate} - ${endDate})`;
            }

            // –î–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
            const addOption = new Option(optionText, event.id);
            eventSelect.appendChild(addOption);

            // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
            const filterOption = new Option(optionText, event.id);
            eventFilter.appendChild(filterOption);
        });

        console.log(`‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä—ã —Å–æ–±—ã—Ç–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${activeEvents.length} —Å–æ–±—ã—Ç–∏–π`);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π)
    async function createTestEvent() {
        try {
            console.log('üéØ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è...');

            const testEvent = {
                name: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ',
                description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
                start_date: new Date().toISOString().split('T')[0], // –°–µ–≥–æ–¥–Ω—è
                end_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // +7 –¥–Ω–µ–π
                location: '–¢–µ—Å—Ç–æ–≤–∞—è –ª–æ–∫–∞—Ü–∏—è',
                registration_required: false
            };

            const response = await fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(testEvent)
            });

            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ:', data);
                showAlert('success', '–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫...');

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è
                await loadActiveEvents();
            } else {
                const error = await response.text();
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–±—ã—Ç–∏—è:', error);
                throw new Error(error);
            }

        } catch (err) {
            console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ:', err);
            showAlert('error', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ. –°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ –≤—Ä—É—á–Ω—É—é –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–æ–±—ã—Ç–∏—è".');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ API —Å–æ–±—ã—Ç–∏–π
    async function diagnoseEventsAPI() {
        console.log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ API —Å–æ–±—ã—Ç–∏–π...');

        const endpoints = [
            '/api/events',
            '/api/visitors/events/active',
            '/api/admin/health'
        ];

        for (const endpoint of endpoints) {
            try {
                console.log(`   –ü—Ä–æ–≤–µ—Ä—è–µ–º ${endpoint}...`);
                const response = await fetch(endpoint, { credentials: 'include' });
                console.log(`   ${endpoint}: ${response.status} ${response.statusText}`);

                if (endpoint === '/api/admin/health' && response.ok) {
                    const health = await response.json();
                    console.log('   –ó–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã:', health);
                }
            } catch (err) {
                console.log(`   ${endpoint}: ‚ùå ${err.message}`);
            }
        }
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–±—ã—Ç–∏—è
    function enhanceVisitorForm() {
        const visitorForm = document.getElementById('visitor-form');
        const eventSelect = document.getElementById('event-select');

        if (!visitorForm || !eventSelect) {
            console.error('‚ùå –§–æ—Ä–º–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏–ª–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
        visitorForm.addEventListener('submit', async (e) => {
            const selectedEventId = eventSelect.value;

            if (!selectedEventId) {
                e.preventDefault();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–±—ã—Ç–∏—è –≤–æ–æ–±—â–µ
                if (activeEvents.length === 0) {
                    const createEvent = confirm(
                        '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞.\n\n' +
                        '–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?\n\n' +
                        '–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–°–æ–±—ã—Ç–∏—è" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤—Ä—É—á–Ω—É—é.'
                    );

                    if (createEvent) {
                        await createTestEvent();
                    } else {
                        showAlert('warning', '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–°–æ–±—ã—Ç–∏—è" –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ');
                        showTab('events');
                    }
                } else {
                    showAlert('error', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
                    eventSelect.focus();
                }

                return false;
            }
        });

        console.log('‚úÖ –§–æ—Ä–º–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è —É–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–±—ã—Ç–∏–π');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    function addDiagnosticsButton() {
        const addVisitorTab = document.getElementById('add-visitor');
        if (!addVisitorTab) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∞
        if (document.getElementById('diagnose-events-btn')) return;

        const diagnosticsHTML = `
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
            <h4 style="color: #17a2b8; margin-bottom: 10px;">üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π</h4>
            <p style="margin-bottom: 15px; color: #666;">–ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ:</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" id="diagnose-events-btn" class="btn-secondary">
                    üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API
                </button>
                <button type="button" id="reload-events-btn" class="btn-secondary">
                    üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
                </button>
                <button type="button" id="create-test-event-btn" class="btn-success">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                </button>
            </div>
        </div>
    `;

        addVisitorTab.insertAdjacentHTML('beforeend', diagnosticsHTML);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        document.getElementById('diagnose-events-btn').addEventListener('click', diagnoseEventsAPI);
        document.getElementById('reload-events-btn').addEventListener('click', loadActiveEvents);
        document.getElementById('create-test-event-btn').addEventListener('click', createTestEvent);

        console.log('‚úÖ –ö–Ω–æ–ø–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        // –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            enhanceVisitorForm();
            addDiagnosticsButton();
        }, 1000);
    });

    console.log('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

    // –ü–æ–∏—Å–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function searchVisitors() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadVisitors(1);
        }, 500);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function filterVisitors() {
        loadVisitors(1);
    }

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
    function previewPhoto() {
        const file = document.getElementById('visitor-photo').files[0];
        const preview = document.getElementById('photo-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            preview.classList.add('hidden');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function handleVisitorFormSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const submitBtn = e.target.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤—ã–±—Ä–∞–Ω–æ
            if (!formData.get('eventId')) {
                throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ');
            }

            const response = await fetch('/api/visitors', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data);
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            console.log('–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:', data.visitor);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const qrUrl = `${window.location.origin}/scan/${data.visitor.visitor_uuid}`;

            document.getElementById('qrcode').innerHTML = '';

            try {
                if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, qrUrl, {
                        width: 200,
                        margin: 2
                    });
                    document.getElementById('qrcode').appendChild(canvas);
                    console.log('‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é QRCode –±–∏–±–ª–∏–æ—Ç–µ–∫–∏');
                } else {
                    throw new Error('QRCode library not available');
                }
            } catch (qrErr) {
                console.warn('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR:', qrErr.message);
                const canvas = document.createElement('canvas');
                await window.SimpleQR.toCanvas(canvas, qrUrl, { width: 200 });
                document.getElementById('qrcode').appendChild(canvas);
            }

            document.getElementById('visitor-result').classList.remove('hidden');
            document.getElementById('visitor-form').style.display = 'none';

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    async function loadVisitors(page = 1) {
        try {
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            const search = document.getElementById('search-input')?.value || '';
            const status = document.getElementById('status-filter')?.value || '';
            const event_id = document.getElementById('event-filter')?.value || '';

            const params = new URLSearchParams({
                page: page,
                limit: 10,
                ...(search && { search }),
                ...(status && { status }),
                ...(event_id && { event_id })
            });

            const response = await fetch(`/api/visitors?${params}`);

            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            visitors = data.visitors;
            currentPage = data.pagination.page;
            totalPages = data.pagination.pages;

            renderVisitors();
            renderPagination();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
            if (err.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')) {
                window.location.href = '/login';
            } else {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π');
            }
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function renderVisitors() {
        const container = document.getElementById('visitors-list');

        if (visitors.length === 0) {
            container.innerHTML = '<div class="alert alert-info">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        container.innerHTML = visitors.map(visitor => `
            <div class="visitor-card">
                <div class="visitor-header">
                    <div class="visitor-name">
                        ${visitor.last_name} ${visitor.first_name} ${visitor.middle_name || ''}
                        ${visitor.event ? `<span class="event-badge">${visitor.event.name}</span>` : ''}
                    </div>
                    <div class="status-badge status-${visitor.status}">
                        ${visitor.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                    </div>
                </div>
                <div class="visitor-info">
                    ${visitor.comment ? `<div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${visitor.comment}</div>` : ''}
                    ${visitor.event ? `<div><strong>–°–æ–±—ã—Ç–∏–µ:</strong> ${visitor.event.name} (${new Date(visitor.event.start_date).toLocaleDateString()} - ${new Date(visitor.event.end_date).toLocaleDateString()})</div>` : ''}
                    <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(visitor.created_at).toLocaleString('ru-RU')} ${visitor.created_by_name ? `(${visitor.created_by_name})` : ''}</div>
                    <div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:</strong> ${visitor.total_scans} (—Å–µ–≥–æ–¥–Ω—è: ${visitor.first_scan_today ? '1+' : '0'})</div>
                </div>
                <div class="visitor-actions">
                    <button class="btn-secondary" data-action="download-qr" data-visitor-id="${visitor.id}">üì• QR-–∫–æ–¥</button>
                    <button class="${visitor.status === 'active' ? 'btn-danger' : 'btn-success'}"
                            data-action="toggle-status" data-visitor-id="${visitor.id}" data-status="${visitor.status}">
                        ${visitor.status === 'active' ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                    </button>
                    ${currentUser.role === 'admin' ?
            `<button class="btn-danger" data-action="delete" data-visitor-id="${visitor.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` :
            ''
        }
                </div>
            </div>
        `).join('');

        container.addEventListener('click', handleVisitorAction);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
    async function loadEvents(page = 1) {
        try {
            if (!currentUser || currentUser.role === 'skd') {
                return;
            }

            const response = await fetch(`/api/events?page=${page}&limit=10`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            events = data.events;
            renderEvents();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π
    function renderEvents() {
        const container = document.getElementById('events-list');

        if (events.length === 0) {
            container.innerHTML = '<div class="alert alert-info">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        container.innerHTML = events.map(event => `
            <div class="event-card">
                <div class="event-header">
                    <div class="event-name">${event.name}</div>
                    <div class="status-badge status-${event.status === 'active' ? 'active' : 'blocked'}">
                        ${getEventStatusText(event.status)}
                    </div>
                </div>
                <div class="event-dates">
                    üìÖ ${new Date(event.start_date).toLocaleDateString('ru-RU')} - ${new Date(event.end_date).toLocaleDateString('ru-RU')}
                </div>
                ${event.location ? `<div class="event-dates">üìç ${event.location}</div>` : ''}
                ${event.description ? `<div class="visitor-info" style="margin: 10px 0;">${event.description}</div>` : ''}

                <div class="event-stats">
                    <div class="event-stat">
                        <div class="event-stat-number">${event.stats.total_visitors}</div>
                        <div class="event-stat-label">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
                    </div>
                    <div class="event-stat">
                        <div class="event-stat-number">${event.stats.total_scans}</div>
                        <div class="event-stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                    </div>
                    <div class="event-stat">
                        <div class="event-stat-number">${event.stats.today_scans}</div>
                        <div class="event-stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>

                <div class="visitor-actions">
                    <button class="btn-secondary" data-action="view-event-visitors" data-event-id="${event.id}">üë• –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
                    <button class="btn-secondary" data-action="view-event-stats" data-event-id="${event.id}">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    ${currentUser.role === 'admin' || currentUser.role === 'moderator' ?
            `<button class="btn-secondary" data-action="edit-event" data-event-id="${event.id}">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>` : ''
        }
                    ${currentUser.role === 'admin' ?
            `<button class="btn-danger" data-action="delete-event" data-event-id="${event.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''
        }
                </div>
            </div>
        `).join('');

        container.addEventListener('click', handleEventAction);
    }

    function getEventStatusText(status) {
        const statusMap = {
            'active': '–ê–∫—Ç–∏–≤–Ω–æ',
            'inactive': '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
        };
        return statusMap[status] || status;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ–±—ã—Ç–∏—è–º–∏
    async function handleEventAction(e) {
        const action = e.target.dataset.action;
        const eventId = e.target.dataset.eventId;

        if (!action || !eventId) return;

        switch (action) {
            case 'view-event-visitors':
                await viewEventVisitors(eventId);
                break;
            case 'view-event-stats':
                await viewEventStats(eventId);
                break;
            case 'edit-event':
                await editEvent(eventId);
                break;
            case 'delete-event':
                await deleteEvent(eventId);
                break;
        }
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏—è
    async function viewEventVisitors(eventId) {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Å–æ–±—ã—Ç–∏—é
        showTab('visitors');
        document.getElementById('event-filter').value = eventId;
        loadVisitors(1);
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è
    async function viewEventStats(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}/stats`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            showEventStatsModal(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è');
        }
    }

    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —Å–æ–±—ã—Ç–∏—è
    function showEventStatsModal(data) {
        const modalHtml = `
            <div id="event-stats-modal" class="modal">
                <div class="modal-content">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.total_visitors}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.active_visitors}</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.total_scans}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.today_scans}</div>
                            <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="closeEventStatsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeEventStatsModal() {
        const modal = document.getElementById('event-stats-modal');
        if (modal) modal.remove();
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    function showCreateEventForm() {
        const formHtml = `
            <div id="create-event-modal" class="modal">
                <div class="modal-content">
                    <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    <form id="create-event-form">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                                <input type="date" name="start_date" required>
                            </div>
                            <div class="form-group">
                                <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                                <input type="date" name="end_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                            <input type="text" name="location">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                                <input type="number" name="max_participants" min="1">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="registration_required"> –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                                </label>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                            <button type="button" class="btn-secondary" onclick="closeCreateEventForm()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', formHtml);

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData);
            eventData.registration_required = formData.has('registration_required');

            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('success', '–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                    closeCreateEventForm();
                    loadEvents();
                    loadActiveEvents(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
                } else {
                    if (data.details && Array.isArray(data.details)) {
                        const errors = data.details.map(detail => detail.msg).join(', ');
                        showAlert('error', `${data.error}: ${errors}`);
                    } else {
                        showAlert('error', data.error);
                    }
                }
            } catch (err) {
                showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
            }
        });
    }

    function closeCreateEventForm() {
        const modal = document.getElementById('create-event-modal');
        if (modal) modal.remove();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
    // (handleVisitorAction, downloadVisitorQR, toggleVisitorStatus, deleteVisitor, etc.)

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏
    async function handleVisitorAction(e) {
        const action = e.target.dataset.action;
        const visitorId = e.target.dataset.visitorId;

        if (!action || !visitorId) return;

        switch (action) {
            case 'download-qr':
                await downloadVisitorQR(visitorId);
                break;
            case 'toggle-status':
                const currentStatus = e.target.dataset.status;
                await toggleVisitorStatus(visitorId, currentStatus);
                break;
            case 'delete':
                await deleteVisitor(visitorId);
                break;
        }
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function downloadVisitorQR(visitorId) {
        try {
            const response = await fetch(`/api/visitors/${visitorId}/qr`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `visitor-qr-${visitorId}.png`;
            link.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞');
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function toggleVisitorStatus(visitorId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
        const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', data.message);
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function deleteVisitor(visitorId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        }
    }

    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    function resetForm() {
        document.getElementById('visitor-form').reset();
        document.getElementById('photo-preview').classList.add('hidden');
        document.getElementById('visitor-result').classList.add('hidden');
        document.getElementById('visitor-form').style.display = 'block';
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
    function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'visitor-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function renderPagination() {
        const container = document.getElementById('visitors-pagination');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        if (currentPage > 1) {
            html += `<button data-page="${currentPage - 1}">‚Üê –ù–∞–∑–∞–¥</button>`;
        }

        html += `<span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}</span>`;

        if (currentPage < totalPages) {
            html += `<button data-page="${currentPage + 1}">–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
        }

        container.innerHTML = html;

        container.addEventListener('click', (e) => {
            const page = e.target.dataset.page;
            if (page) {
                loadVisitors(parseInt(page));
            }
        });
    }

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
    function startScanner() {
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        if (typeof QrScanner === 'undefined') {
            showAlert('warning', 'QR —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.');
            return;
        }

        qrScanner = new QrScanner(video, result => {
            handleScanResult(result.data);
        }, {
            returnDetailedScanResult: true,
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        qrScanner.start().then(() => {
            video.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
            showAlert('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        });
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    function stopScanner() {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
            qrScanner = null;
        }

        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        video.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    async function handleScanResult(qrData) {
        try {
            let uuid = null;

            if (qrData.includes('/scan/')) {
                uuid = qrData.split('/scan/')[1];
            } else if (qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)) {
                uuid = qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)[0];
            }

            if (!uuid) {
                showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                return;
            }

            const response = await fetch(`/api/scan/${uuid}`, {
                method: 'GET'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            displayScanResult(data);
            stopScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞');
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function displayScanResult(data) {
        const container = document.getElementById('scan-info');

        if (data.status === 'error') {
            container.innerHTML = `
                <div class="alert alert-error">
                    <h4>‚ùå ${data.title}</h4>
                    <p>${data.message}</p>
                </div>
            `;
        } else if (data.status === 'success') {
            container.innerHTML = `
                <div class="alert alert-success">
                    <h4>‚úÖ ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–í—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${new Date(data.scanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å</p>
                </div>
            `;
        } else if (data.status === 'warning') {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${new Date(data.firstScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</strong> ${new Date(data.currentScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </div>
            `;
        }

        document.getElementById('scan-result').classList.remove('hidden');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStats() {
        try {
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            const response = await fetch('/api/visitors/stats/overview');

            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderStats(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            if (err.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')) {
                window.location.href = '/login';
            } else {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderStats(data) {
        const overview = document.getElementById('stats-overview');
        const eventsStats = document.getElementById('events-stats');
        const activity = document.getElementById('recent-activity');

        // –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        overview.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${data.visitors.total_visitors}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.visitors.active_visitors}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.today_scans}</div>
                <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.week_scans}</div>
                <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        `;

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º
        if (data.eventStats && data.eventStats.length > 0) {
            eventsStats.innerHTML = `
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º</h3>
                <div class="events-grid">
                    ${data.eventStats.map(event => `
                        <div class="event-card">
                            <div class="event-name">${event.name}</div>
                            <div class="event-stats">
                                <div class="event-stat">
                                    <div class="event-stat-number">${event.visitors_count}</div>
                                    <div class="event-stat-label">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
                                </div>
                                <div class="event-stat">
                                    <div class="event-stat-number">${event.scans_count}</div>
                                    <div class="event-stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                                </div>
                                <div class="event-stat">
                                    <div class="event-stat-number">${event.today_scans}</div>
                                    <div class="event-stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            eventsStats.innerHTML = '<h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–æ–±—ã—Ç–∏—è–º</h3>';
        }

        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (data.recentActivity && data.recentActivity.length > 0) {
            activity.innerHTML = `
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <div class="visitor-list">
                    ${data.recentActivity.map(scan => `
                        <div class="visitor-card">
                            <div class="visitor-header">
                                <div class="visitor-name">
                                    ${scan.last_name} ${scan.first_name} ${scan.middle_name || ''}
                                    ${scan.event_name ? `<span class="event-badge">${scan.event_name}</span>` : ''}
                                </div>
                                <div class="status-badge status-${scan.scan_type === 'first' ? 'active' : 'blocked'}">
                                    ${scan.scan_type === 'first' ? '–ü–µ—Ä–≤–æ–µ' : '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ'}
                                </div>
                            </div>
                            <div class="visitor-info">
                                <div><strong>–í—Ä–µ–º—è:</strong> ${new Date(scan.scanned_at).toLocaleString('ru-RU')}</div>
                                ${scan.scanned_by_name ? `<div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–ª:</strong> ${scan.scanned_by_name}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            activity.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    async function loadAdminPanel() {
        if (currentUser.role !== 'admin') {
            return;
        }

        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderAdminPanel(data.users);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    function renderAdminPanel(users) {
        const container = document.getElementById('users-management');

        container.innerHTML = `
            <div style="margin-bottom: 20px;">
                <button class="btn-success" onclick="showAlert('info', '–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
            <div class="alert alert-info">
                –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}
            </div>
        `;
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.tab-container'));

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
        } finally {
            window.location.href = '/login';
        }
    }
</script>
</body>
</html>