<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" onclick="app.logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" data-tab="visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" data-tab="add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" data-tab="events">üéØ –°–æ–±—ã—Ç–∏—è</button>
        <button class="tab" data-tab="scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" data-tab="admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ -->
    <div id="visitors" class="content active">
        <div class="filters-section">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, —Å–æ–±—ã—Ç–∏—é...">
            <select id="status-filter">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
            </select>
            <select id="event-filter">
                <option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
            </select>
            <button onclick="app.visitors.filter()">üîç –ù–∞–π—Ç–∏</button>
            <button onclick="app.visitors.resetFilters()">üîÑ –°–±—Ä–æ—Å</button>
        </div>

        <div class="table-container">
            <div class="table-header">
                <span>–°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</span>
                <span id="visitors-count">0</span>
            </div>
            <div id="visitors-table" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="visitors-pagination" class="pagination hidden"></div>
    </div>

    <!-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <select name="eventId" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>
            </select>
            <input name="lastName" placeholder="–§–∞–º–∏–ª–∏—è" required>
            <input name="firstName" placeholder="–ò–º—è" required>
            <input name="middleName" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ">
            <textarea name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
            <input type="file" name="photo" accept="image/*">
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</button>
        </form>
        <div id="qr-result" class="hidden"></div>
    </div>

    <!-- –°–æ–±—ã—Ç–∏—è -->
    <div id="events" class="content">
        <button onclick="app.events.showCreateForm()">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        <div id="events-list"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <video id="qr-video" class="hidden"></video>
        <button id="scanner-btn" onclick="app.scanner.toggle()">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <div id="scan-result" class="hidden"></div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div id="stats-overview" class="stats-grid"></div>
        <div id="stats-tables"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <button onclick="app.admin.showCreateUserForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <div id="users-table" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="users-pagination" class="pagination hidden"></div>
    </div>
</div>

<script>
    // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const app = {
        state: {
            currentUser: null,
            visitors: [],
            events: [],
            users: [],
            pagination: {
                visitors: { page: 1, size: 25, total: 0 },
                users: { page: 1, size: 25, total: 0 }
            }
        },

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            this.setupEventListeners();

            if (await this.auth.check()) {
                await Promise.all([
                    this.events.loadActive(),
                    this.visitors.load(),
                    this.stats.load()
                ]);
                console.log('‚úÖ –ì–æ—Ç–æ–≤–æ');
            }
        },

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => this.showTab(tab.dataset.tab);
            });

            // –ü–æ–∏—Å–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
            document.getElementById('search-input').oninput =
                this.debounce(() => this.visitors.load(1), 500);

            // –§–∏–ª—å—Ç—Ä—ã
            document.getElementById('status-filter').onchange = () => this.visitors.load(1);
            document.getElementById('event-filter').onchange = () => this.visitors.load(1);

            // –§–æ—Ä–º–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
            document.getElementById('visitor-form').onsubmit = this.visitors.create.bind(this);
        },

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        showTab(tab) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            const loaders = {
                visitors: () => this.visitors.load(),
                'add-visitor': () => this.events.loadActive(),
                events: () => this.events.load(),
                stats: () => this.stats.load(),
                admin: () => this.admin.load()
            };
            loaders[tab]?.();
        },

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        auth: {
            async check() {
                try {
                    const res = await fetch('/api/auth/check');
                    const data = await res.json();

                    if (!data.authenticated) {
                        window.location.href = '/login';
                        return false;
                    }

                    app.state.currentUser = data.user;
                    app.updateUserInterface();
                    return true;
                } catch (err) {
                    window.location.href = '/login';
                    return false;
                }
            }
        },

        // –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏
        visitors: {
            async load(page = 1) {
                const params = new URLSearchParams({
                    page,
                    limit: app.state.pagination.visitors.size,
                    search: document.getElementById('search-input').value,
                    status: document.getElementById('status-filter').value,
                    event_id: document.getElementById('event-filter').value
                });

                try {
                    const res = await fetch(`/api/visitors?${params}`);
                    const data = await res.json();

                    app.state.visitors = data.visitors;
                    app.state.pagination.visitors = data.pagination;

                    this.render();
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π');
                }
            },

            render() {
                const container = document.getElementById('visitors-table');
                const visitors = app.state.visitors;

                document.getElementById('visitors-count').textContent = visitors.length;

                if (visitors.length === 0) {
                    container.innerHTML = '<div class="empty">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>–§–ò–û</th>
                            <th>–°–æ–±—ã—Ç–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${visitors.map(v => `
                            <tr>
                                <td>
                                    <strong>${v.last_name} ${v.first_name} ${v.middle_name || ''}</strong>
                                    ${v.comment ? `<br><small>${v.comment}</small>` : ''}
                                </td>
                                <td><span class="badge">${v.event?.name || '–ë–µ–∑ —Å–æ–±—ã—Ç–∏—è'}</span></td>
                                <td><span class="status-${v.status}">${v.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span></td>
                                <td>${v.total_scans} ${v.first_scan_today ? '(—Å–µ–≥–æ–¥–Ω—è)' : ''}</td>
                                <td>
                                    <button onclick="app.visitors.downloadQR(${v.id})">üì•</button>
                                    <button onclick="app.visitors.toggleStatus(${v.id}, '${v.status}')">${v.status === 'active' ? 'üîí' : 'üîì'}</button>
                                    ${app.state.currentUser.role === 'admin' ? `<button onclick="app.visitors.delete(${v.id})">üóëÔ∏è</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

                app.renderPagination('visitors');
            },

            async create(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const res = await fetch('/api/visitors', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                        this.showQRResult(data.visitor);
                    } else {
                        app.showAlert('error', data.error);
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
                }
            },

            showQRResult(visitor) {
                const qrUrl = `${window.location.origin}/scan/${visitor.visitor_uuid}`;
                const container = document.getElementById('qr-result');

                container.innerHTML = `
                <div class="qr-container">
                    <canvas id="qr-canvas"></canvas>
                    <p>QR-–∫–æ–¥ –¥–ª—è ${visitor.last_name} ${visitor.first_name}</p>
                    <button onclick="app.visitors.downloadQRCanvas()">üì• –°–∫–∞—á–∞—Ç—å</button>
                    <button onclick="app.visitors.resetForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
                </div>
            `;
                container.classList.remove('hidden');

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.getElementById('qr-canvas'), qrUrl);
                }
            },

            async downloadQR(id) {
                try {
                    const res = await fetch(`/api/visitors/${id}/qr`);
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `visitor-qr-${id}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR');
                }
            },

            async toggleStatus(id, currentStatus) {
                const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
                const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

                if (!confirm(`${action} –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) return;

                try {
                    const res = await fetch(`/api/visitors/${id}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async delete(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?')) return;

                try {
                    const res = await fetch(`/api/visitors/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        app.showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            filter() {
                this.load(1);
            },

            resetFilters() {
                document.getElementById('search-input').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('event-filter').value = '';
                this.load(1);
            },

            resetForm() {
                document.getElementById('visitor-form').reset();
                document.getElementById('qr-result').classList.add('hidden');
            }
        },

        // –°–æ–±—ã—Ç–∏—è
        events: {
            async loadActive() {
                try {
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π...');
                    const res = await fetch('/api/visitors/events/active');

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    console.log('–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);

                    const select = document.querySelector('#visitor-form select[name="eventId"]');
                    const filter = document.getElementById('event-filter');

                    [select, filter].forEach(el => {
                        if (!el) return;

                        el.innerHTML = el === select ? '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>' : '<option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>';

                        if (data.events && data.events.length > 0) {
                            data.events.forEach(event => {
                                const option = new Option(event.name, event.id);
                                el.appendChild(option);
                            });
                        }
                    });

                    console.log('–°–ø–∏—Å–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ' + err.message);
                }
            },

            async load() {
                try {
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π...');
                    const res = await fetch('/api/events');

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' }));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    console.log('–°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);

                    app.state.events = data.events || [];
                    this.render();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ' + err.message);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                    const container = document.getElementById('events-list');
                    if (container) {
                        container.innerHTML = `
                    <div class="empty" style="color: #dc3545;">
                        <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</h3>
                        <p>${err.message}</p>
                        <button onclick="app.events.load()" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
                    }
                }
            },

            render() {
                const container = document.getElementById('events-list');
                if (!container) {
                    console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä events-list –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const events = app.state.events;
                console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π:', events);

                if (!events || events.length === 0) {
                    container.innerHTML = `
                <div class="empty">
                    <h3>üìã –°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</p>
                    <button onclick="app.events.showCreateForm()" style="margin-top: 15px;">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                </div>
            `;
                    return;
                }

                container.innerHTML = events.map(e => `
            <div class="event-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <h3>${e.name}</h3>
                    <span class="status-${e.status}" style="font-size: 12px; padding: 4px 8px;">
                        ${this.getStatusText(e.status)}
                    </span>
                </div>

                ${e.description ? `<p style="color: #666; margin-bottom: 10px;">${e.description}</p>` : ''}

                <div style="margin-bottom: 10px;">
                    <p><strong>üìÖ –î–∞—Ç—ã:</strong> ${this.formatDate(e.start_date)} - ${this.formatDate(e.end_date)}</p>
                    ${e.location ? `<p><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${e.location}</p>` : ''}
                    ${e.max_participants ? `<p><strong>üë• –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> ${e.max_participants}</p>` : ''}
                </div>

                <div class="stats">
                    <span title="–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π">üë• ${e.stats.total_visitors}</span>
                    <span title="–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π">‚úÖ ${e.stats.active_visitors}</span>
                    <span title="–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π">üì± ${e.stats.total_scans}</span>
                    <span title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è">üìä ${e.stats.today_scans}</span>
                </div>

                ${app.state.currentUser.role !== 'skd' ? `
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="app.events.viewDetails(${e.id})" style="font-size: 12px; padding: 6px 12px;">üìã –ü–æ–¥—Ä–æ–±–Ω–æ</button>
                        ${app.state.currentUser.role === 'admin' || app.state.currentUser.role === 'moderator' ? `
                            <button onclick="app.events.showEditForm(${e.id})" style="font-size: 12px; padding: 6px 12px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="app.events.toggleStatus(${e.id}, '${e.status}')" style="font-size: 12px; padding: 6px 12px;">
                                ${e.status === 'active' ? '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        ` : ''}
                        ${app.state.currentUser.role === 'admin' ? `
                            <button onclick="app.events.delete(${e.id})" style="font-size: 12px; padding: 6px 12px; background: #dc3545;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `).join('');
            },

            getStatusText(status) {
                const statusMap = {
                    'active': '–ê–∫—Ç–∏–≤–Ω–æ',
                    'inactive': '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ',
                    'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                    'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
                };
                return statusMap[status] || status;
            },

            formatDate(dateString) {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('ru-RU');
            },

            showCreateForm() {
                app.showModal(`
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
            <form id="event-form">
                <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" required>
                <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                        <input name="start_date" type="date" required>
                    </div>
                    <div>
                        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                        <input name="end_date" type="date" required>
                    </div>
                </div>
                <input name="location" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <input name="max_participants" type="number" placeholder="–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" min="1">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input name="registration_required" type="checkbox">
                    –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </label>
                <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            </form>
        `, async (formData) => {
                    try {
                        const eventData = Object.fromEntries(formData);
                        eventData.registration_required = formData.get('registration_required') === 'on';

                        // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
                        Object.keys(eventData).forEach(key => {
                            if (eventData[key] === '' || eventData[key] === null) {
                                delete eventData[key];
                            }
                        });

                        console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:', eventData);

                        const res = await fetch('/api/events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        });

                        const data = await res.json();

                        if (res.ok) {
                            app.showAlert('success', '–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                            this.load();
                            this.loadActive(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                        } else {
                            throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                        }
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                    }
                });
            },

            async viewDetails(id) {
                try {
                    const res = await fetch(`/api/events/${id}`);
                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è');
                    }

                    app.showModal(`
                <h3>üìã ${data.name}</h3>
                <div style="text-align: left;">
                    ${data.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${data.description}</p>` : ''}
                    <p><strong>üìÖ –ü–µ—Ä–∏–æ–¥:</strong> ${this.formatDate(data.start_date)} - ${this.formatDate(data.end_date)}</p>
                    ${data.location ? `<p><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${data.location}</p>` : ''}
                    <p><strong>üìä –°—Ç–∞—Ç—É—Å:</strong> ${this.getStatusText(data.status)}</p>
                    ${data.max_participants ? `<p><strong>üë• –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> ${data.max_participants}</p>` : ''}
                    <p><strong>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong> ${data.registration_required ? '–¢—Ä–µ–±—É–µ—Ç—Å—è' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}</p>

                    <h4 style="margin-top: 20px;">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: <strong>${data.stats.total_visitors}</strong></div>
                        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö: <strong>${data.stats.active_visitors}</strong></div>
                        <div>–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: <strong>${data.stats.total_scans}</strong></div>
                        <div>–°–µ–≥–æ–¥–Ω—è: <strong>${data.stats.today_scans}</strong></div>
                    </div>

                    ${data.created_by_name ? `<p style="margin-top: 15px; font-size: 12px; color: #666;">–°–æ–∑–¥–∞–Ω–æ: ${data.created_by_name}</p>` : ''}
                </div>
            `);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                }
            },

            async toggleStatus(id, currentStatus) {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                const action = newStatus === 'active' ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';

                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?`)) return;

                try {
                    const res = await fetch(`/api/events/${id}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', data.message);
                        this.load();
                        this.loadActive(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + err.message);
                }
            },

            async delete(id) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

                try {
                    const res = await fetch(`/api/events/${id}`, { method: 'DELETE' });
                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', data.message);
                        this.load();
                        this.loadActive(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                }
            }
        },

        // –°–∫–∞–Ω–µ—Ä
        scanner: {
            instance: null,

            toggle() {
                if (this.instance) {
                    this.stop();
                } else {
                    this.start();
                }
            },

            async start() {
                if (typeof QrScanner === 'undefined') {
                    app.showAlert('error', 'QR —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }

                const video = document.getElementById('qr-video');
                const btn = document.getElementById('scanner-btn');

                this.instance = new QrScanner(video, result => {
                    this.handleResult(result.data);
                });

                try {
                    await this.instance.start();
                    video.classList.remove('hidden');
                    btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
                }
            },

            stop() {
                if (this.instance) {
                    this.instance.stop();
                    this.instance = null;
                    document.getElementById('qr-video').classList.add('hidden');
                    document.getElementById('scanner-btn').textContent = 'üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
                }
            },

            async handleResult(qrData) {
                let uuid = null;

                if (qrData.includes('/scan/')) {
                    uuid = qrData.split('/scan/')[1];
                } else if (qrData.match(/[0-9a-f-]{36}/i)) {
                    uuid = qrData.match(/[0-9a-f-]{36}/i)[0];
                }

                if (!uuid) {
                    app.showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                    return;
                }

                try {
                    const res = await fetch(`/api/scan/${uuid}`);
                    const data = await res.json();

                    this.showResult(data);
                    this.stop();
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            },

            showResult(data) {
                const container = document.getElementById('scan-result');

                const statusClass = {
                    success: 'success',
                    warning: 'warning',
                    error: 'error'
                }[data.status] || 'info';

                container.innerHTML = `
                <div class="alert alert-${statusClass}">
                    <h4>${data.icon} ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(data.scanTime || data.currentScanTime).toLocaleString()}</p>
                </div>
            `;
                container.classList.remove('hidden');
            }
        },

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats: {
            async load() {
                try {
                    const res = await fetch('/api/visitors/stats/overview');
                    const data = await res.json();

                    this.render(data);
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }
            },

            render(data) {
                const overview = document.getElementById('stats-overview');
                overview.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.visitors.total_visitors}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.visitors.active_visitors}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans.today_scans}</div>
                    <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans.week_scans}</div>
                    <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
            `;
            }
        },

        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        admin: {
            async load() {
                if (app.state.currentUser.role !== 'admin') return;

                try {
                    const res = await fetch('/api/admin/users');
                    const data = await res.json();

                    app.state.users = data.users;
                    this.render();
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                }
            },

            render() {
                const container = document.getElementById('users-table');
                const users = app.state.users;

                container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–†–æ–ª—å</th>
                            <th>Email</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td>
                                    <strong>${u.fullName}</strong><br>
                                    <small>@${u.username}</small>
                                </td>
                                <td><span class="role-${u.role}">${app.getRoleText(u.role)}</span></td>
                                <td>${u.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                <td><span class="status-${u.isActive ? 'active' : 'blocked'}">${u.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span></td>
                                <td>
                                    <button onclick="app.admin.resetPassword(${u.id})">üîë</button>
                                    <button onclick="app.admin.toggleStatus(${u.id}, ${u.isActive})" ${u.id === app.state.currentUser.id ? 'disabled' : ''}>${u.isActive ? 'üîí' : 'üîì'}</button>
                                    ${u.id !== app.state.currentUser.id ? `<button onclick="app.admin.deleteUser(${u.id})">üóëÔ∏è</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            },

            showCreateUserForm() {
                app.showModal(`
                <h3>–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <form id="user-form">
                    <input name="username" placeholder="–õ–æ–≥–∏–Ω" required>
                    <input name="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    <input name="fullName" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è" required>
                    <select name="role" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                        <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                        <option value="skd">–°–ö–î</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                    <input name="email" type="email" placeholder="Email">
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                </form>
            `, async (formData) => {
                    try {
                        const res = await fetch('/api/admin/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(Object.fromEntries(formData))
                        });

                        if (res.ok) {
                            app.showAlert('success', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                            this.load();
                        } else {
                            const data = await res.json();
                            app.showAlert('error', data.error);
                        }
                    } catch (err) {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    }
                });
            },

            async resetPassword(id) {
                const password = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
                if (!password) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: password })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω');
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async toggleStatus(id, isActive) {
                if (!confirm(isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?')) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isActive: !isActive })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async deleteUser(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        app.showAlert('success', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            }
        },

        // –£—Ç–∏–ª–∏—Ç—ã
        updateUserInterface() {
            const user = this.state.currentUser;
            document.getElementById('user-badge').textContent = `${user.fullName} (${this.getRoleText(user.role)})`;

            if (user.role === 'skd') {
                document.querySelectorAll('.tab').forEach(t => t.disabled = !['scanner'].includes(t.dataset.tab));
                this.showTab('scanner');
            } else if (user.role === 'admin') {
                document.querySelector('[data-tab="admin"]').disabled = false;
            }
        },

        getRoleText(role) {
            return { admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', moderator: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', skd: '–°–ö–î' }[role] || role;
        },

        showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        },

        showModal(html, onSubmit) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `<div class="modal-content">${html}</div>`;
            document.body.appendChild(modal);

            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            if (onSubmit) {
                modal.querySelector('form').onsubmit = async (e) => {
                    e.preventDefault();
                    await onSubmit(new FormData(e.target));
                    modal.remove();
                };
            }
        },

        renderPagination(type) {
            const container = document.getElementById(`${type}-pagination`);
            const pagination = this.state.pagination[type];

            if (pagination.total <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.innerHTML = `
            <button onclick="app.${type}.load(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>‚Üê</button>
            <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${pagination.pages}</span>
            <button onclick="app.${type}.load(${pagination.page + 1})" ${pagination.page === pagination.pages ? 'disabled' : ''}>‚Üí</button>
        `;
            container.classList.remove('hidden');
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        async logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } finally {
                window.location.href = '/login';
            }
        }
    };

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>