<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è QR –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
    <script>
        window.SimpleQR = {
            toCanvas: function(canvas, text, options = {}) {
                return new Promise((resolve, reject) => {
                    try {
                        const ctx = canvas.getContext('2d');
                        const size = options.width || 200;
                        canvas.width = size;
                        canvas.height = size;

                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, size, size);
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(10, 10, size-20, size-20);

                        ctx.fillStyle = '#000000';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', size/2, size/2 - 20);
                        ctx.fillText('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', size/2, size/2);

                        const maxWidth = size - 40;
                        const words = text.replace(/https?:\/\//, '').split('/');
                        let line = '';
                        let y = size/2 + 20;

                        ctx.font = '10px Arial';
                        for (let i = 0; i < words.length && y < size - 20; i++) {
                            const testLine = line + words[i] + '/';
                            const metrics = ctx.measureText(testLine);

                            if (metrics.width > maxWidth && i > 0) {
                                ctx.fillText(line, size/2, y);
                                line = words[i] + '/';
                                y += 12;
                            } else {
                                line = testLine;
                            }
                        }
                        if (y < size - 20) {
                            ctx.fillText(line, size/2, y);
                        }

                        resolve(canvas);
                    } catch (err) {
                        reject(err);
                    }
                });
            }
        };

        async function loadQRLibraries() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ QR –±–∏–±–ª–∏–æ—Ç–µ–∫...');
            const qrSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js',
                'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js'
            ];

            for (const src of qrSources) {
                try {
                    await loadScript(src);
                    if (typeof QRCode !== 'undefined' || typeof qrcode !== 'undefined') {
                        console.log('‚úÖ QR –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å:', src);
                        window.QRCode = window.QRCode || window.qrcode;
                        return true;
                    }
                } catch (err) {
                    console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å QRCode —Å:', src, err.message);
                    continue;
                }
            }

            console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π QR –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä');
            window.QRCode = window.SimpleQR;
            return false;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                script.src = src;
                script.async = true;
                document.head.appendChild(script);

                setTimeout(() => {
                    reject(new Error('Timeout loading script'));
                }, 5000);
            });
        }

        async function loadQRScanner() {
            try {
                await loadScript('https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js');
                console.log('‚úÖ QR Scanner –∑–∞–≥—Ä—É–∂–µ–Ω');
                return true;
            } catch (err) {
                console.log('‚ö†Ô∏è QR Scanner –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return false;
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: #333;
            font-size: 2.2em;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .tab-container {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 6px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
        }

        .btn-filter {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-reset {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
        }

        .table-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .data-table th:hover {
            background: #e9ecef;
        }

        .data-table th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }

        .data-table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        .data-table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-blocked {
            background: #f8d7da;
            color: #721c24;
        }

        .event-badge {
            background: #e3f2fd;
            color: #0277bd;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π */
        .actions-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-qr {
            background: #17a2b8;
            color: white;
        }

        .btn-qr:hover {
            background: #138496;
        }

        .btn-block {
            background: #dc3545;
            color: white;
        }

        .btn-block:hover {
            background: #c82333;
        }

        .btn-unblock {
            background: #28a745;
            color: white;
        }

        .btn-unblock:hover {
            background: #1e7e34;
        }

        .btn-delete {
            background: #6c757d;
            color: white;
        }

        .btn-delete:hover {
            background: #545b62;
        }

        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination-section {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            flex: 1;
            min-width: 200px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pagination-nav {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .pagination-section {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-controls {
                justify-content: center;
            }

            .actions-cell {
                flex-direction: column;
            }

            .tab-container {
                flex-wrap: wrap;
            }

            .tab {
                flex: none;
                min-width: 120px;
            }
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none !important;
        }

        /* –î—Ä—É–≥–∏–µ —Å—Ç–∏–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #dc3545;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" id="logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" id="tab-visitors" data-tab="visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" id="tab-add-visitor" data-tab="add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" id="tab-events" data-tab="events">üéØ –°–æ–±—ã—Ç–∏—è</button>
        <button class="tab" id="tab-scanner" data-tab="scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" id="tab-stats" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" id="tab-admin" data-tab="admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π -->
    <div id="visitors" class="content active">
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="search-input">–ü–æ–∏—Å–∫</label>
                    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, —Å–æ–±—ã—Ç–∏—é...">
                </div>
                <div class="filter-group">
                    <label for="status-filter">–°—Ç–∞—Ç—É—Å</label>
                    <select id="status-filter">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="event-filter">–°–æ–±—ã—Ç–∏–µ</label>
                    <select id="event-filter">
                        <option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter" onclick="applyFilters()">üîç –ù–∞–π—Ç–∏</button>
                    <button class="btn-reset" onclick="resetFilters()">üîÑ –°–±—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">–°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                <div class="table-count" id="visitors-count">0 –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
            </div>

            <div id="visitors-table-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                </div>
            </div>
        </div>

        <div class="pagination-section" id="visitors-pagination-section" style="display: none;">
            <div class="pagination-info">
                <div><strong>–ü–æ–∫–∞–∑–∞–Ω–æ:</strong> <span id="visitors-showing">0</span> –∏–∑ <span id="visitors-total">0</span></div>
                <div><strong>–°—Ç—Ä–∞–Ω–∏—Ü–∞:</strong> <span id="visitors-current-page">1</span> –∏–∑ <span id="visitors-total-pages">1</span></div>
            </div>
            <div class="pagination-controls">
                <div class="page-size-selector">
                    <label>–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                    <select id="visitors-page-size" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="pagination-nav" id="visitors-pagination-nav">
                    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="event-select">–°–æ–±—ã—Ç–∏–µ <span class="required">*</span></label>
                <select id="event-select" name="eventId" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>
                </select>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label for="last-name">–§–∞–º–∏–ª–∏—è <span class="required">*</span></label>
                    <input type="text" id="last-name" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="first-name">–ò–º—è <span class="required">*</span></label>
                    <input type="text" id="first-name" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="middle-name">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                    <input type="text" id="middle-name" name="middleName">
                </div>
            </div>

            <div class="form-group">
                <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            </div>

            <div class="form-group">
                <label for="visitor-photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                <input type="file" id="visitor-photo" name="photo" accept="image/*">
                <img id="photo-preview" class="hidden" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px auto; display: block; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            </div>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥</button>
        </form>

        <div id="visitor-result" class="hidden">
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px; margin-top: 20px;">
                <div id="qrcode" style="display: inline-block; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                <p style="margin-top: 15px; font-weight: 600;">QR-–∫–æ–¥ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</p>
                <button type="button" id="download-qr-btn" style="background: linear-gradient(135deg, #6c757d, #545b62); margin-left: 10px;">üì• –°–∫–∞—á–∞—Ç—å QR</button>
                <button type="button" id="reset-form-btn" style="background: linear-gradient(135deg, #6c757d, #545b62); margin-left: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
            </div>
        </div>
    </div>

    <!-- –°–æ–±—ã—Ç–∏—è -->
    <div id="events" class="content">
        <div style="margin-bottom: 20px;">
            <button id="create-event-btn" style="background: linear-gradient(135deg, #28a745, #1e7e34);">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        </div>

        <div id="events-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;"></div>
        <div id="events-pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <div style="text-align: center; margin: 20px 0;">
            <video id="qr-video" class="hidden" style="width: 100%; max-width: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></video>
        </div>
        <button id="start-scanner-btn">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button class="hidden" id="stop-scanner-btn" style="background: linear-gradient(135deg, #6c757d, #545b62); margin-left: 10px;">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div id="scan-result" class="hidden">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="scan-info"></div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div class="stats-grid" id="stats-overview"></div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º</div>
                <div class="table-count" id="events-stats-count">0 —Å–æ–±—ã—Ç–∏–π</div>
            </div>
            <div id="events-stats-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
            </div>
            <div id="recent-scans-content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        <div id="users-management"></div>
    </div>
</div>

<script>
    let currentUser = null;
    let visitors = [];
    let events = [];
    let activeEvents = [];
    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;
    let sortField = null;
    let sortDirection = 'asc';
    let qrScanner = null;
    let searchTimeout = null;
    let qrLibraryLoaded = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
        console.clear();
        console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

        try {
            qrLibraryLoaded = await loadQRLibraries();
            await loadQRScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫:', err);
        }

        setupEventListeners();

        const isAuthenticated = await checkAuth();
        if (isAuthenticated) {
            console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            await Promise.all([
                loadActiveEvents(),
                loadVisitors(),
                loadStats(),
                loadEvents()
            ]);
            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                if (tabName) showTab(tabName);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
        document.getElementById('logout-btn').addEventListener('click', logout);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('search-input').addEventListener('keyup', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadVisitors(1);
            }, 500);
        });

        document.getElementById('status-filter').addEventListener('change', () => loadVisitors(1));
        document.getElementById('event-filter').addEventListener('change', () => loadVisitors(1));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        document.getElementById('visitor-form').addEventListener('submit', handleVisitorFormSubmit);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        document.getElementById('visitor-photo').addEventListener('change', previewPhoto);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ QR
        document.getElementById('download-qr-btn').addEventListener('click', downloadQR);
        document.getElementById('reset-form-btn').addEventListener('click', resetForm);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
        document.getElementById('start-scanner-btn').addEventListener('click', startScanner);
        document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        document.getElementById('create-event-btn').addEventListener('click', showCreateEventForm);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check');
            const data = await response.json();

            if (!data.authenticated) {
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                window.location.href = '/login';
                return false;
            }

            currentUser = data.user;
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.username);
            updateUserInterface();
            return true;
        } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
            window.location.href = '/login';
            return false;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUserInterface() {
        document.getElementById('user-badge').textContent =
            `${currentUser.fullName} (${getRoleText(currentUser.role)})`;

        const tabAddVisitor = document.getElementById('tab-add-visitor');
        const tabAdmin = document.getElementById('tab-admin');
        const tabVisitors = document.getElementById('tab-visitors');
        const tabStats = document.getElementById('tab-stats');
        const tabEvents = document.getElementById('tab-events');

        if (currentUser.role === 'skd') {
            // –°–ö–î —Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            tabAddVisitor.disabled = true;
            tabVisitors.disabled = true;
            tabStats.disabled = true;
            tabEvents.disabled = true;
            showTab('scanner');
        } else if (currentUser.role === 'admin') {
            // –ê–¥–º–∏–Ω - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
            tabAdmin.disabled = false;
        } else if (currentUser.role === 'moderator') {
            // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä - –≤—Å–µ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            tabEvents.disabled = false;
        }
    }

    function getRoleText(role) {
        const roles = {
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
            'skd': '–°–ö–î'
        };
        return roles[role] || role;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
        document.querySelectorAll('.content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        if (tabName === 'visitors') {
            loadVisitors();
        } else if (tabName === 'stats') {
            loadStats();
        } else if (tabName === 'admin') {
            loadAdminPanel();
        } else if (tabName === 'events') {
            loadEvents();
        } else if (tabName === 'add-visitor') {
            loadActiveEvents();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞
    async function loadActiveEvents() {
        try {
            const response = await fetch('/api/visitors/events/active');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            activeEvents = data.events;
            updateEventSelectors();
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${activeEvents.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π`);

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:', err);
            activeEvents = [];
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π');
        }
    }

    function updateEventSelectors() {
        const eventSelect = document.getElementById('event-select');
        const eventFilter = document.getElementById('event-filter');

        eventSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>';
        eventFilter.innerHTML = '<option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>';

        activeEvents.forEach(event => {
            const startDate = new Date(event.start_date).toLocaleDateString('ru-RU');
            const endDate = new Date(event.end_date).toLocaleDateString('ru-RU');

            let optionText = event.name;
            if (startDate === endDate) {
                optionText += ` (${startDate})`;
            } else {
                optionText += ` (${startDate} - ${endDate})`;
            }

            const addOption = new Option(optionText, event.id);
            eventSelect.appendChild(addOption);

            const filterOption = new Option(optionText, event.id);
            eventFilter.appendChild(filterOption);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    async function loadVisitors(page = 1) {
        try {
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            showLoading('visitors-table-content');

            const search = document.getElementById('search-input')?.value || '';
            const status = document.getElementById('status-filter')?.value || '';
            const event_id = document.getElementById('event-filter')?.value || '';

            const params = new URLSearchParams({
                page: page,
                limit: pageSize,
                ...(search && { search }),
                ...(status && { status }),
                ...(event_id && { event_id })
            });

            const response = await fetch(`/api/visitors?${params}`);

            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            visitors = data.visitors;
            currentPage = data.pagination.page;
            totalPages = data.pagination.pages;

            renderVisitorsTable();
            updatePagination();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
            document.getElementById('visitors-table-content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùå</div>
                    <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                    <p>${err.message}</p>
                </div>
            `;
        }
    }

    function renderVisitorsTable() {
        const container = document.getElementById('visitors-table-content');

        document.getElementById('visitors-count').textContent = `${visitors.length} –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π`;

        if (visitors.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <h3>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                </div>
            `;
            document.getElementById('visitors-pagination-section').style.display = 'none';
            return;
        }

        const tableHtml = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('last_name')">
                            –§–ò–û ${getSortIcon('last_name')}
                        </th>
                        <th class="sortable" onclick="sortTable('event.name')">
                            –°–æ–±—ã—Ç–∏–µ ${getSortIcon('event.name')}
                        </th>
                        <th class="sortable" onclick="sortTable('status')">
                            –°—Ç–∞—Ç—É—Å ${getSortIcon('status')}
                        </th>
                        <th class="sortable" onclick="sortTable('total_scans')">
                            –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π ${getSortIcon('total_scans')}
                        </th>
                        <th class="sortable" onclick="sortTable('created_at')">
                            –°–æ–∑–¥–∞–Ω ${getSortIcon('created_at')}
                        </th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    ${visitors.map(visitor => `
                        <tr>
                            <td>
                                <div style="font-weight: 600; margin-bottom: 2px;">
                                    ${visitor.last_name} ${visitor.first_name} ${visitor.middle_name || ''}
                                </div>
                                ${visitor.comment ? `<div style="font-size: 12px; color: #666;">${visitor.comment}</div>` : ''}
                            </td>
                            <td>
                                <span class="event-badge">${visitor.event?.name || '–ë–µ–∑ —Å–æ–±—ã—Ç–∏—è'}</span>
                            </td>
                            <td>
                                <span class="status-badge status-${visitor.status}">
                                    ${visitor.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                </span>
                            </td>
                            <td>
                                <div style="font-weight: 600;">${visitor.total_scans}</div>
                                ${visitor.first_scan_today ? '<div style="font-size: 12px; color: #28a745;">–°–µ–≥–æ–¥–Ω—è: –¥–∞</div>' : '<div style="font-size: 12px; color: #666;">–°–µ–≥–æ–¥–Ω—è: –Ω–µ—Ç</div>'}
                            </td>
                            <td>
                                <div>${new Date(visitor.created_at).toLocaleDateString('ru-RU')}</div>
                                <div style="font-size: 12px; color: #666;">${visitor.created_by_name || ''}</div>
                            </td>
                            <td>
                                <div class="actions-cell">
                                    <button class="btn-action btn-qr" onclick="downloadVisitorQR(${visitor.id})" title="–°–∫–∞—á–∞—Ç—å QR">
                                        üì• QR
                                    </button>
                                    <button class="btn-action ${visitor.status === 'active' ? 'btn-block' : 'btn-unblock'}"
                                            onclick="toggleVisitorStatus(${visitor.id}, '${visitor.status}')"
                                            title="${visitor.status === 'active' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}">
                                        ${visitor.status === 'active' ? 'üîí' : 'üîì'}
                                    </button>
                                    ${currentUser.role === 'admin' ? `
                                        <button class="btn-action btn-delete" onclick="deleteVisitor(${visitor.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                            üóëÔ∏è
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        container.innerHTML = tableHtml;
        document.getElementById('visitors-pagination-section').style.display = 'flex';
    }

    function updatePagination() {
        document.getElementById('visitors-current-page').textContent = currentPage;
        document.getElementById('visitors-total-pages').textContent = totalPages;

        const showing = Math.min(pageSize, visitors.length);
        document.getElementById('visitors-showing').textContent = showing;

        // –¢—É—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π, –Ω–æ –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        document.getElementById('visitors-total').textContent = visitors.length;

        renderPaginationNav();
    }

    function renderPaginationNav() {
        const nav = document.getElementById('visitors-pagination-nav');
        const buttons = [];

        // –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–≤–∞—è"
        buttons.push(`
            <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(1)">
                ‚èÆ –ü–µ—Ä–≤–∞—è
            </button>
        `);

        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        buttons.push(`
            <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
                ‚Üê –ü—Ä–µ–¥
            </button>
        `);

        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        const start = Math.max(1, currentPage - 2);
        const end = Math.min(totalPages, currentPage + 2);

        if (start > 1) {
            buttons.push(`<button class="page-btn" onclick="goToPage(1)">1</button>`);
            if (start > 2) buttons.push(`<span class="page-btn" style="cursor: default;">...</span>`);
        }

        for (let i = start; i <= end; i++) {
            buttons.push(`
                <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                    ${i}
                </button>
            `);
        }

        if (end < totalPages) {
            if (end < totalPages - 1) buttons.push(`<span class="page-btn" style="cursor: default;">...</span>`);
            buttons.push(`<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`);
        }

        // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
        buttons.push(`
            <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
                –°–ª–µ–¥ ‚Üí
            </button>
        `);

        // –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å–ª–µ–¥–Ω—è—è"
        buttons.push(`
            <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${totalPages})">
                –ü–æ—Å–ª–µ–¥–Ω—è—è ‚è≠
            </button>
        `);

        nav.innerHTML = buttons.join('');
    }

    function goToPage(page) {
        if (page >= 1 && page <= totalPages && page !== currentPage) {
            loadVisitors(page);
        }
    }

    function changePageSize() {
        pageSize = parseInt(document.getElementById('visitors-page-size').value);
        loadVisitors(1);
    }

    function applyFilters() {
        loadVisitors(1);
    }

    function resetFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('event-filter').value = '';
        sortField = null;
        sortDirection = 'asc';
        loadVisitors(1);
    }

    function sortTable(field) {
        if (sortField === field) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortField = field;
            sortDirection = 'asc';
        }

        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        loadVisitors(currentPage);
    }

    function getSortIcon(field) {
        if (sortField === field) {
            return sortDirection === 'asc' ? '‚Üë' : '‚Üì';
        }
        return '‚Üï';
    }

    // –î–µ–π—Å—Ç–≤–∏—è —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏
    async function downloadVisitorQR(visitorId) {
        try {
            const response = await fetch(`/api/visitors/${visitorId}/qr`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `visitor-qr-${visitorId}.png`;
            link.click();
            window.URL.revokeObjectURL(url);

            showAlert('success', 'QR –∫–æ–¥ —Å–∫–∞—á–∞–Ω');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞');
        }
    }

    async function toggleVisitorStatus(visitorId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
        const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', data.message);
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }

    async function deleteVisitor(visitorId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function handleVisitorFormSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const submitBtn = e.target.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            if (!formData.get('eventId')) {
                throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ');
            }

            const response = await fetch('/api/visitors', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const qrUrl = `${window.location.origin}/scan/${data.visitor.visitor_uuid}`;

            document.getElementById('qrcode').innerHTML = '';

            try {
                if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, qrUrl, {
                        width: 200,
                        margin: 2
                    });
                    document.getElementById('qrcode').appendChild(canvas);
                } else {
                    throw new Error('QRCode library not available');
                }
            } catch (qrErr) {
                const canvas = document.createElement('canvas');
                await window.SimpleQR.toCanvas(canvas, qrUrl, { width: 200 });
                document.getElementById('qrcode').appendChild(canvas);
            }

            document.getElementById('visitor-result').classList.remove('hidden');
            document.getElementById('visitor-form').style.display = 'none';

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥';
        }
    }

    function previewPhoto() {
        const file = document.getElementById('visitor-photo').files[0];
        const preview = document.getElementById('photo-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            preview.classList.add('hidden');
        }
    }

    function resetForm() {
        document.getElementById('visitor-form').reset();
        document.getElementById('photo-preview').classList.add('hidden');
        document.getElementById('visitor-result').classList.add('hidden');
        document.getElementById('visitor-form').style.display = 'block';
    }

    function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'visitor-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStats() {
        try {
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            showLoading('stats-overview');
            showLoading('events-stats-content');
            showLoading('recent-scans-content');

            const response = await fetch('/api/visitors/stats/overview');

            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderStats(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
    }

    function renderStats(data) {
        const overview = document.getElementById('stats-overview');
        const eventsStats = document.getElementById('events-stats-content');
        const activity = document.getElementById('recent-scans-content');

        // –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        overview.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${data.visitors.total_visitors}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.visitors.active_visitors}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.today_scans}</div>
                <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.week_scans}</div>
                <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        `;

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º
        if (data.eventStats && data.eventStats.length > 0) {
            document.getElementById('events-stats-count').textContent = `${data.eventStats.length} —Å–æ–±—ã—Ç–∏–π`;

            const tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</th>
                            <th>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</th>
                            <th>–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                            <th>–°–µ–≥–æ–¥–Ω—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.eventStats.map(event => `
                            <tr>
                                <td style="font-weight: 600;">${event.name}</td>
                                <td>${event.visitors_count}</td>
                                <td>${event.scans_count}</td>
                                <td style="font-weight: 600; color: #28a745;">${event.today_scans}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            eventsStats.innerHTML = tableHtml;
        } else {
            eventsStats.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–æ–±—ã—Ç–∏—è–º</h3></div>';
        }

        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (data.recentActivity && data.recentActivity.length > 0) {
            const tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å</th>
                            <th>–°–æ–±—ã—Ç–∏–µ</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–¢–∏–ø</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.recentActivity.map(scan => `
                            <tr>
                                <td style="font-weight: 600;">
                                    ${scan.last_name} ${scan.first_name} ${scan.middle_name || ''}
                                </td>
                                <td>
                                    <span class="event-badge">${scan.event_name || '–ë–µ–∑ —Å–æ–±—ã—Ç–∏—è'}</span>
                                </td>
                                <td>${new Date(scan.scanned_at).toLocaleString('ru-RU')}</td>
                                <td>
                                    <span class="status-badge status-${scan.scan_type === 'first' ? 'active' : 'blocked'}">
                                        ${scan.scan_type === 'first' ? '–ü–µ—Ä–≤–æ–µ' : '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            activity.innerHTML = tableHtml;
        } else {
            activity.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3></div>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
    async function loadEvents(page = 1) {
        try {
            if (!currentUser || currentUser.role === 'skd') {
                return;
            }

            const response = await fetch(`/api/events?page=${page}&limit=10`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            events = data.events;
            renderEvents();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π');
        }
    }

    function renderEvents() {
        const container = document.getElementById('events-list');

        if (events.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéØ</div><h3>–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3></div>';
            return;
        }

        container.innerHTML = events.map(event => `
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; transition: all 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div style="font-size: 1.3em; font-weight: 700; color: #333; line-height: 1.2;">${event.name}</div>
                    <div class="status-badge status-${event.status === 'active' ? 'active' : 'blocked'}">
                        ${getEventStatusText(event.status)}
                    </div>
                </div>
                <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    üìÖ ${new Date(event.start_date).toLocaleDateString('ru-RU')} - ${new Date(event.end_date).toLocaleDateString('ru-RU')}
                </div>
                ${event.location ? `<div style="color: #666; font-size: 14px; margin-bottom: 10px;">üìç ${event.location}</div>` : ''}
                ${event.description ? `<div style="margin: 10px 0; color: #666;">${event.description}</div>` : ''}

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #667eea;">${event.stats.total_visitors}</div>
                        <div style="font-size: 12px; color: #666;">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #667eea;">${event.stats.total_scans}</div>
                        <div style="font-size: 12px; color: #666;">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: #667eea;">${event.stats.today_scans}</div>
                        <div style="font-size: 12px; color: #666;">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-action" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 14px;" onclick="viewEventVisitors(${event.id})">üë• –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
                    <button class="btn-action" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 14px;" onclick="viewEventStats(${event.id})">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                    ${currentUser.role === 'admin' || currentUser.role === 'moderator' ?
            `<button class="btn-action" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 14px;" onclick="editEvent(${event.id})">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>` : ''
        }
                    ${currentUser.role === 'admin' ?
            `<button class="btn-action btn-delete" style="padding: 8px 16px; font-size: 14px;" onclick="deleteEvent(${event.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''
        }
                </div>
            </div>
        `).join('');
    }

    function getEventStatusText(status) {
        const statusMap = {
            'active': '–ê–∫—Ç–∏–≤–Ω–æ',
            'inactive': '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ',
            'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
        };
        return statusMap[status] || status;
    }

    async function viewEventVisitors(eventId) {
        showTab('visitors');
        document.getElementById('event-filter').value = eventId;
        loadVisitors(1);
    }

    async function viewEventStats(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}/stats`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showEventStatsModal(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è');
        }
    }

    function showEventStatsModal(data) {
        const modalHtml = `
            <div id="event-stats-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #333;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.total_visitors}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.active_visitors}</div>
                            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.total_scans}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.stats.today_scans}</div>
                            <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                    </div>
                    <button style="background: linear-gradient(135deg, #6c757d, #545b62);" onclick="closeEventStatsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function closeEventStatsModal() {
        const modal = document.getElementById('event-stats-modal');
        if (modal) modal.remove();
    }

    function showCreateEventForm() {
        const formHtml = `
            <div id="create-event-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #333;">–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    <form id="create-event-form">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" rows="3"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                                <input type="date" name="start_date" required>
                            </div>
                            <div class="form-group">
                                <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                                <input type="date" name="end_date" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                            <input type="text" name="location">
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label>–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                                <input type="number" name="max_participants" min="1">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="registration_required"> –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                                </label>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                            <button type="button" style="background: linear-gradient(135deg, #6c757d, #545b62);" onclick="closeCreateEventForm()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            </div>`;

        document.body.insertAdjacentHTML('beforeend', formHtml);

        document.getElementById('create-event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData);
            eventData.registration_required = formData.has('registration_required');

            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('success', '–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                    closeCreateEventForm();
                    loadEvents();
                    loadActiveEvents();
                } else {
                    if (data.details && Array.isArray(data.details)) {
                        const errors = data.details.map(detail => detail.msg).join(', ');
                        showAlert('error', `${data.error}: ${errors}`);
                    } else {
                        showAlert('error', data.error);
                    }
                }
            } catch (err) {
                showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
            }
        });
    }

    function closeCreateEventForm() {
        const modal = document.getElementById('create-event-modal');
        if (modal) modal.remove();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    async function loadAdminPanel() {
        if (currentUser.role !== 'admin') {
            return;
        }

        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderAdminPanel(data.users);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
    }

    function renderAdminPanel(users) {
        const container = document.getElementById('users-management');

        container.innerHTML = `
            <div style="margin-bottom: 20px;">
                <button style="background: linear-gradient(135deg, #28a745, #1e7e34);" onclick="showAlert('info', '–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
            <div class="alert alert-info">
                –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}
            </div>
        `;
    }

    // –°–∫–∞–Ω–µ—Ä QR –∫–æ–¥–æ–≤
    function startScanner() {
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        if (typeof QrScanner === 'undefined') {
            showAlert('warning', 'QR —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.');
            return;
        }

        qrScanner = new QrScanner(video, result => {
            handleScanResult(result.data);
        }, {
            returnDetailedScanResult: true,
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        qrScanner.start().then(() => {
            video.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
            showAlert('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        });
    }

    function stopScanner() {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
            qrScanner = null;
        }

        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        video.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
    }

    async function handleScanResult(qrData) {
        try {
            let uuid = null;

            if (qrData.includes('/scan/')) {
                uuid = qrData.split('/scan/')[1];
            } else if (qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)) {
                uuid = qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)[0];
            }

            if (!uuid) {
                showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                return;
            }

            const response = await fetch(`/api/scan/${uuid}`, {
                method: 'GET'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            displayScanResult(data);
            stopScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞');
        }
    }

    function displayScanResult(data) {
        const container = document.getElementById('scan-info');

        if (data.status === 'error') {
            container.innerHTML = `
                <div class="alert alert-error">
                    <h4>‚ùå ${data.title}</h4>
                    <p>${data.message}</p>
                </div>
            `;
        } else if (data.status === 'success') {
            container.innerHTML = `
                <div class="alert alert-success">
                    <h4>‚úÖ ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–í—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${new Date(data.scanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å</p>
                </div>
            `;
        } else if (data.status === 'warning') {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${new Date(data.firstScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</strong> ${new Date(data.currentScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </div>
            `;
        }

        document.getElementById('scan-result').classList.remove('hidden');
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function showLoading(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        `;
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.tab-container'));

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
        } finally {
            window.location.href = '/login';
        }
    }
</script>
</body>
</html>