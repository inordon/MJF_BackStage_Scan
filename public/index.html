<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è QR –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ -->
    <script>
        // –ü—Ä–æ—Å—Ç–∞—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è QR –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
        window.SimpleQR = {
            toCanvas: function(canvas, text, options = {}) {
                return new Promise((resolve, reject) => {
                    try {
                        const ctx = canvas.getContext('2d');
                        const size = options.width || 200;
                        canvas.width = size;
                        canvas.height = size;

                        // –ü—Ä–æ—Å—Ç–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ backup
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, size, size);

                        // –†–∞–º–∫–∞
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(10, 10, size-20, size-20);

                        ctx.fillStyle = '#000000';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('QR-–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', size/2, size/2 - 20);
                        ctx.fillText('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', size/2, size/2);

                        // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π URL –Ω–∞ —á–∞—Å—Ç–∏
                        const maxWidth = size - 40;
                        const words = text.replace(/https?:\/\//, '').split('/');
                        let line = '';
                        let y = size/2 + 20;

                        ctx.font = '10px Arial';
                        for (let i = 0; i < words.length && y < size - 20; i++) {
                            const testLine = line + words[i] + '/';
                            const metrics = ctx.measureText(testLine);

                            if (metrics.width > maxWidth && i > 0) {
                                ctx.fillText(line, size/2, y);
                                line = words[i] + '/';
                                y += 12;
                            } else {
                                line = testLine;
                            }
                        }
                        if (y < size - 20) {
                            ctx.fillText(line, size/2, y);
                        }

                        resolve(canvas);
                    } catch (err) {
                        reject(err);
                    }
                });
            },

            toBuffer: function(text, options = {}) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    this.toCanvas(canvas, text, options).then(() => {
                        canvas.toBlob(resolve, 'image/png');
                    });
                });
            }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ QR –±–∏–±–ª–∏–æ—Ç–µ–∫ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ fallback'–∞–º–∏
        async function loadQRLibraries() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ QR –±–∏–±–ª–∏–æ—Ç–µ–∫...');

            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Ä–∞–∑–Ω—ã—Ö CDN
            const qrSources = [
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js'
            ];

            for (const src of qrSources) {
                try {
                    await loadScript(src);
                    if (typeof QRCode !== 'undefined') {
                        console.log('‚úÖ QRCode –∑–∞–≥—Ä—É–∂–µ–Ω —Å:', src);
                        return true;
                    }
                } catch (err) {
                    console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å QRCode —Å:', src, err.message);
                    continue;
                }
            }

            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
            console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π QR –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä');
            window.QRCode = window.SimpleQR;
            return false;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —É–∂–µ —Å–∫—Ä–∏–ø—Ç
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                script.src = src;
                script.async = true;
                document.head.appendChild(script);

                // –¢–∞–π–º–∞—É—Ç –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                setTimeout(() => {
                    reject(new Error('Timeout loading script'));
                }, 5000);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ QR Scanner (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        async function loadQRScanner() {
            try {
                await loadScript('https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js');
                console.log('‚úÖ QR Scanner –∑–∞–≥—Ä—É–∂–µ–Ω');
                return true;
            } catch (err) {
                console.log('‚ö†Ô∏è QR Scanner –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ñ—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞');
                return false;
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: #333;
            font-size: 2.2em;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .tab-container {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 6px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #dc3545;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #545b62);
            margin-left: 10px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .visitor-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .visitor-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .visitor-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-blocked {
            background: #f8d7da;
            color: #721c24;
        }

        .visitor-info {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .visitor-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .visitor-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        #qr-video {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none !important;
        }

        .photo-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #666;
            font-size: 16px;
        }

        .library-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .library-status.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .visitor-actions {
                flex-direction: column;
            }

            .tab-container {
                flex-wrap: wrap;
            }

            .tab {
                flex: none;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" id="logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" id="tab-visitors" data-tab="visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" id="tab-add-visitor" data-tab="add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" id="tab-scanner" data-tab="scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" id="tab-stats" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" id="tab-admin" data-tab="admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π -->
    <div id="visitors" class="content active">
        <div class="form-row" style="margin-bottom: 20px;">
            <div class="form-group">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É...">
            </div>
            <div class="form-group">
                <select id="status-filter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                </select>
            </div>
        </div>

        <div id="visitors-list"></div>
        <div id="visitors-pagination" class="pagination"></div>
    </div>

    <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label for="last-name">–§–∞–º–∏–ª–∏—è <span class="required">*</span></label>
                    <input type="text" id="last-name" name="lastName" required>
                </div>
                <div class="form-group">
                    <label for="first-name">–ò–º—è <span class="required">*</span></label>
                    <input type="text" id="first-name" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="middle-name">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                    <input type="text" id="middle-name" name="middleName">
                </div>
            </div>

            <div class="form-group">
                <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment" name="comment" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
            </div>

            <div class="form-group">
                <label for="visitor-photo">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</label>
                <input type="file" id="visitor-photo" name="photo" accept="image/*">
                <img id="photo-preview" class="photo-preview hidden" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            </div>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥</button>
        </form>

        <div id="visitor-result" class="hidden">
            <div class="qr-container">
                <div id="qrcode"></div>
                <p style="margin-top: 15px; font-weight: 600;">QR-–∫–æ–¥ –¥–ª—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</p>
                <button type="button" id="download-qr-btn" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å QR</button>
                <button type="button" id="reset-form-btn" class="btn-secondary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
            </div>
        </div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <div class="scanner-container">
            <video id="qr-video" class="hidden"></video>
        </div>
        <button id="start-scanner-btn">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <button class="hidden" id="stop-scanner-btn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

        <div id="scan-result" class="hidden">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
            <div id="scan-info"></div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div class="stats-grid" id="stats-overview"></div>
        <div id="recent-activity"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
        <div id="users-management"></div>
    </div>
</div>

<div id="library-status" class="library-status"></div>

<script>
    let currentUser = null;
    let visitors = [];
    let currentPage = 1;
    let totalPages = 1;
    let qrScanner = null;
    let searchTimeout = null;
    let qrLibraryLoaded = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
        console.clear();
        console.log('üöÄ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

        showLibraryStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...');

        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        try {
            qrLibraryLoaded = await loadQRLibraries();
            await loadQRScanner();
            showLibraryStatus('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚úÖ', 2000);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫:', err);
            showLibraryStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚ùå', 3000);
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const isAuthenticated = await checkAuth();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
        if (isAuthenticated) {
            console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            await Promise.all([loadVisitors(), loadStats()]);
            console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
    });

    // –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
    function showLibraryStatus(message, hideAfter = 0) {
        const statusEl = document.getElementById('library-status');
        statusEl.textContent = message;
        statusEl.classList.add('show');

        if (hideAfter > 0) {
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, hideAfter);
        }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                if (tabName) showTab(tabName);
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
        document.getElementById('logout-btn').addEventListener('click', logout);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('search-input').addEventListener('keyup', searchVisitors);
        document.getElementById('status-filter').addEventListener('change', filterVisitors);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
        document.getElementById('visitor-form').addEventListener('submit', handleVisitorFormSubmit);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        document.getElementById('visitor-photo').addEventListener('change', previewPhoto);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ QR
        document.getElementById('download-qr-btn').addEventListener('click', downloadQR);
        document.getElementById('reset-form-btn').addEventListener('click', resetForm);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
        document.getElementById('start-scanner-btn').addEventListener('click', startScanner);
        document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/check');
            const data = await response.json();

            if (!data.authenticated) {
                console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                window.location.href = '/login';
                return false;
            }

            currentUser = data.user;
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.username);
            updateUserInterface();
            return true;
        } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
            window.location.href = '/login';
            return false;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    function updateUserInterface() {
        document.getElementById('user-badge').textContent =
            `${currentUser.fullName} (${getRoleText(currentUser.role)})`;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–æ–∫
        const tabAddVisitor = document.getElementById('tab-add-visitor');
        const tabAdmin = document.getElementById('tab-admin');
        const tabVisitors = document.getElementById('tab-visitors');
        const tabStats = document.getElementById('tab-stats');

        if (currentUser.role === 'skd') {
            // –°–ö–î —Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            tabAddVisitor.disabled = true;
            tabVisitors.disabled = true;
            tabStats.disabled = true;
            showTab('scanner');
        } else if (currentUser.role === 'admin') {
            // –ê–¥–º–∏–Ω - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
            tabAdmin.disabled = false;
        }
    }

    function getRoleText(role) {
        const roles = {
            'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            'moderator': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
            'skd': '–°–ö–î'
        };
        return roles[role] || role;
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function showTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('.content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
        if (tabName === 'visitors') {
            loadVisitors();
        } else if (tabName === 'stats') {
            loadStats();
        } else if (tabName === 'admin') {
            loadAdminPanel();
        }
    }

    // –ü–æ–∏—Å–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function searchVisitors() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadVisitors(1);
        }, 500);
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function filterVisitors() {
        loadVisitors(1);
    }

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
    function previewPhoto() {
        const file = document.getElementById('visitor-photo').files[0];
        const preview = document.getElementById('photo-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            preview.classList.add('hidden');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function handleVisitorFormSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const submitBtn = e.target.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const response = await fetch('/api/visitors', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const qrUrl = `${window.location.origin}/scan/${data.visitor.visitor_uuid}`;

            document.getElementById('qrcode').innerHTML = '';

            try {
                if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, qrUrl, {
                        width: 200,
                        margin: 2
                    });
                    document.getElementById('qrcode').appendChild(canvas);
                    console.log('‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é QRCode –±–∏–±–ª–∏–æ—Ç–µ–∫–∏');
                } else {
                    throw new Error('QRCode library not available');
                }
            } catch (qrErr) {
                console.warn('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä QR:', qrErr.message);
                const canvas = document.createElement('canvas');
                await window.SimpleQR.toCanvas(canvas, qrUrl, { width: 200 });
                document.getElementById('qrcode').appendChild(canvas);
            }

            document.getElementById('visitor-result').classList.remove('hidden');
            document.getElementById('visitor-form').style.display = 'none';

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω');
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è –∏ QR-–∫–æ–¥';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    async function loadVisitors(page = 1) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            const search = document.getElementById('search-input')?.value || '';
            const status = document.getElementById('status-filter')?.value || '';

            const params = new URLSearchParams({
                page: page,
                limit: 10,
                ...(search && { search }),
                ...(status && { status })
            });

            const response = await fetch(`/api/visitors?${params}`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            visitors = data.visitors;
            currentPage = data.pagination.page;
            totalPages = data.pagination.pages;

            renderVisitors();
            renderPagination();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
            if (err.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')) {
                window.location.href = '/login';
            } else {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π');
            }
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
    function renderVisitors() {
        const container = document.getElementById('visitors-list');

        if (visitors.length === 0) {
            container.innerHTML = '<div class="alert alert-info">–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        container.innerHTML = visitors.map(visitor => `
            <div class="visitor-card">
                <div class="visitor-header">
                    <div class="visitor-name">${visitor.last_name} ${visitor.first_name} ${visitor.middle_name || ''}</div>
                    <div class="status-badge status-${visitor.status}">
                        ${visitor.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                    </div>
                </div>
                <div class="visitor-info">
                    ${visitor.comment ? `<div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${visitor.comment}</div>` : ''}
                    <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(visitor.created_at).toLocaleString('ru-RU')} ${visitor.created_by_name ? `(${visitor.created_by_name})` : ''}</div>
                    <div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:</strong> ${visitor.total_scans} (—Å–µ–≥–æ–¥–Ω—è: ${visitor.first_scan_today ? '1+' : '0'})</div>
                </div>
                <div class="visitor-actions">
                    <button class="btn-secondary" data-action="download-qr" data-visitor-id="${visitor.id}">üì• QR-–∫–æ–¥</button>
                    <button class="${visitor.status === 'active' ? 'btn-danger' : 'btn-success'}"
                            data-action="toggle-status" data-visitor-id="${visitor.id}" data-status="${visitor.status}">
                        ${visitor.status === 'active' ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                    </button>
                    ${currentUser.role === 'admin' ?
            `<button class="btn-danger" data-action="delete" data-visitor-id="${visitor.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` :
            ''
        }
                </div>
            </div>
        `).join('');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        container.addEventListener('click', handleVisitorAction);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏
    async function handleVisitorAction(e) {
        const action = e.target.dataset.action;
        const visitorId = e.target.dataset.visitorId;

        if (!action || !visitorId) return;

        switch (action) {
            case 'download-qr':
                await downloadVisitorQR(visitorId);
                break;
            case 'toggle-status':
                const currentStatus = e.target.dataset.status;
                await toggleVisitorStatus(visitorId, currentStatus);
                break;
            case 'delete':
                await deleteVisitor(visitorId);
                break;
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function renderPagination() {
        const container = document.getElementById('visitors-pagination');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        if (currentPage > 1) {
            html += `<button data-page="${currentPage - 1}">‚Üê –ù–∞–∑–∞–¥</button>`;
        }

        html += `<span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}</span>`;

        if (currentPage < totalPages) {
            html += `<button data-page="${currentPage + 1}">–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
        }

        container.innerHTML = html;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        container.addEventListener('click', (e) => {
            const page = e.target.dataset.page;
            if (page) {
                loadVisitors(parseInt(page));
            }
        });
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function downloadVisitorQR(visitorId) {
        try {
            const response = await fetch(`/api/visitors/${visitorId}/qr`);

            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞');
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `visitor-qr-${visitorId}.png`;
            link.click();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR –∫–æ–¥–∞');
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function toggleVisitorStatus(visitorId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
        const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', data.message);
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
    async function deleteVisitor(visitorId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            return;
        }

        try {
            const response = await fetch(`/api/visitors/${visitorId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
            loadVisitors(currentPage);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:', err);
            showAlert('error', err.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
        }
    }

    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    function resetForm() {
        document.getElementById('visitor-form').reset();
        document.getElementById('photo-preview').classList.add('hidden');
        document.getElementById('visitor-result').classList.add('hidden');
        document.getElementById('visitor-form').style.display = 'block';
    }

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
    function downloadQR() {
        const canvas = document.querySelector('#qrcode canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'visitor-qr-code.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    }

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
    function startScanner() {
        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        if (typeof QrScanner === 'undefined') {
            showAlert('warning', 'QR —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.');
            return;
        }

        qrScanner = new QrScanner(video, result => {
            handleScanResult(result.data);
        }, {
            returnDetailedScanResult: true,
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        qrScanner.start().then(() => {
            video.classList.remove('hidden');
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
            showAlert('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        });
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
    function stopScanner() {
        if (qrScanner) {
            qrScanner.stop();
            qrScanner.destroy();
            qrScanner = null;
        }

        const video = document.getElementById('qr-video');
        const startBtn = document.getElementById('start-scanner-btn');
        const stopBtn = document.getElementById('stop-scanner-btn');

        video.classList.add('hidden');
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    async function handleScanResult(qrData) {
        try {
            let uuid = null;

            // –ò–∑–≤–ª–µ–∫–∞–µ–º UUID –∏–∑ QR –∫–æ–¥–∞
            if (qrData.includes('/scan/')) {
                uuid = qrData.split('/scan/')[1];
            } else if (qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)) {
                uuid = qrData.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i)[0];
            }

            if (!uuid) {
                showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
            const response = await fetch(`/api/scan/${uuid}`, {
                method: 'GET'
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            displayScanResult(data);
            stopScanner();
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ QR –∫–æ–¥–∞');
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function displayScanResult(data) {
        const container = document.getElementById('scan-info');

        if (data.status === 'error') {
            container.innerHTML = `
                <div class="alert alert-error">
                    <h4>‚ùå ${data.title}</h4>
                    <p>${data.message}</p>
                </div>
            `;
        } else if (data.status === 'success') {
            container.innerHTML = `
                <div class="alert alert-success">
                    <h4>‚úÖ ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–í—Ä–µ–º—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${new Date(data.scanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å</p>
                </div>
            `;
        } else if (data.status === 'warning') {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <h4>‚ö†Ô∏è ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–ü–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> ${new Date(data.firstScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</strong> ${new Date(data.currentScanTime).toLocaleString('ru-RU')}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                </div>
            `;
        }

        document.getElementById('scan-result').classList.remove('hidden');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStats() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!currentUser) {
                console.log('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }

            const response = await fetch('/api/visitors/stats/overview');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (response.status === 401) {
                console.log('üîë –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                window.location.href = '/login';
                return;
            }

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderStats(data);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            if (err.message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')) {
                window.location.href = '/login';
            } else {
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderStats(data) {
        const overview = document.getElementById('stats-overview');
        const activity = document.getElementById('recent-activity');

        // –û–±–∑–æ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        overview.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${data.visitors.total_visitors}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.visitors.active_visitors}</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.today_scans}</div>
                <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.scans.week_scans}</div>
                <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        `;

        // –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        if (data.recentActivity && data.recentActivity.length > 0) {
            activity.innerHTML = `
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <div class="visitor-list">
                    ${data.recentActivity.map(scan => `
                        <div class="visitor-card">
                            <div class="visitor-header">
                                <div class="visitor-name">${scan.last_name} ${scan.first_name} ${scan.middle_name || ''}</div>
                                <div class="status-badge status-${scan.scan_type === 'first' ? 'active' : 'blocked'}">
                                    ${scan.scan_type === 'first' ? '–ü–µ—Ä–≤–æ–µ' : '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ'}
                                </div>
                            </div>
                            <div class="visitor-info">
                                <div><strong>–í—Ä–µ–º—è:</strong> ${new Date(scan.scanned_at).toLocaleString('ru-RU')}</div>
                                ${scan.scanned_by_name ? `<div><strong>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–ª:</strong> ${scan.scanned_by_name}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            activity.innerHTML = '<div class="alert alert-info">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–∏—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    async function loadAdminPanel() {
        if (currentUser.role !== 'admin') {
            return;
        }

        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            renderAdminPanel(data.users);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
    function renderAdminPanel(users) {
        const container = document.getElementById('users-management');

        container.innerHTML = `
            <div style="margin-bottom: 20px;">
                <button class="btn-success" id="create-user-btn">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                <button class="btn-secondary" id="system-stats-btn">üìä –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            </div>

            <div id="users-list">
                ${users.map(user => `
                    <div class="visitor-card">
                        <div class="visitor-header">
                            <div class="visitor-name">${user.fullName} (${user.username})</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="status-badge status-${user.isActive ? 'active' : 'blocked'}">
                                    ${getRoleText(user.role)}
                                </div>
                                ${!user.isActive ? '<div class="status-badge status-blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</div>' : ''}
                                ${user.id === currentUser.id ? '<div class="status-badge" style="background: #d1ecf1; color: #0c5460;">–≠—Ç–æ –≤—ã</div>' : ''}
                            </div>
                        </div>
                        <div class="visitor-info">
                            <div><strong>Email:</strong> ${user.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(user.createdAt).toLocaleString('ru-RU')}</div>
                            <div><strong>–°–æ–∑–¥–∞–ª:</strong> ${user.createdByName || '–°–∏—Å—Ç–µ–º–∞'}</div>
                            <div><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π:</strong> ${user.activeSessions}</div>
                        </div>
                        <div class="visitor-actions">
                            <button class="btn-secondary" data-action="reset-password" data-user-id="${user.id}">üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                            <button class="${user.isActive ? 'btn-danger' : 'btn-success'}"
                                    data-action="toggle-user-status" data-user-id="${user.id}" data-active="${user.isActive}"
                                    ${user.id === currentUser.id ? 'disabled' : ''}>
                                ${user.isActive ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            ${user.id !== currentUser.id ?
            `<button class="btn-danger" data-action="delete-user" data-user-id="${user.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` :
            ''
        }
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('create-user-btn').addEventListener('click', () => {
            showAlert('info', '–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });

        document.getElementById('system-stats-btn').addEventListener('click', loadSystemStats);

        container.addEventListener('click', handleAdminAction);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    async function handleAdminAction(e) {
        const action = e.target.dataset.action;
        const userId = e.target.dataset.userId;

        if (!action || !userId) return;

        switch (action) {
            case 'reset-password':
                showAlert('info', '–§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                break;
            case 'toggle-user-status':
                showAlert('info', '–§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                break;
            case 'delete-user':
                showAlert('info', '–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                break;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadSystemStats() {
        try {
            const response = await fetch('/api/admin/stats');
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error);
            }

            showAlert('info', `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:\n‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏: ${data.database.active_visitors}\n‚Ä¢ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è: ${data.database.today_scans}`);
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
            showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
    }

    // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.tab-container'));

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
        } finally {
            window.location.href = '/login';
        }
    }
</script>
</body>
</html>