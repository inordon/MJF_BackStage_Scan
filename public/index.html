<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>

    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üë• –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</h1>
        <div class="user-info">
            <div class="user-badge" id="user-badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button class="logout-btn" onclick="app.logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab active" data-tab="visitors">üìã –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</button>
        <button class="tab" data-tab="add-visitor">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="tab" data-tab="events">üéØ –°–æ–±—ã—Ç–∏—è</button>
        <button class="tab" data-tab="scanner">üì± –°–∫–∞–Ω–µ—Ä</button>
        <button class="tab" data-tab="stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="tab" data-tab="admin" disabled>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    </div>

    <!-- –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ -->
    <div id="visitors" class="content active">
        <div class="filters-section">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û, —Å–æ–±—ã—Ç–∏—é, —à—Ç—Ä–∏—Ö–∫–æ–¥—É...">
            <select id="status-filter">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
            </select>
            <select id="event-filter">
                <option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</option>
            </select>
            <button onclick="app.visitors.filter()">üîç –ù–∞–π—Ç–∏</button>
            <button onclick="app.visitors.resetFilters()">üîÑ –°–±—Ä–æ—Å</button>
            <button onclick="app.events.loadActiveForFilters()" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π">üîÑ –°–æ–±—ã—Ç–∏—è</button>
            <button onclick="app.visitors.testEventsAPI()" title="–¢–µ—Å—Ç API —Å–æ–±—ã—Ç–∏–π">üß™ –¢–µ—Å—Ç API</button>
        </div>

        <div class="table-container">
            <div class="table-header">
                <span>–°–ø–∏—Å–æ–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</span>
                <span id="visitors-count">0</span>
            </div>
            <div id="visitors-table">
                <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <div id="visitors-pagination" class="pagination hidden"></div>
    </div>

    <!-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è -->
    <div id="add-visitor" class="content">
        <form id="visitor-form" enctype="multipart/form-data">
            <select name="eventId" required>
                <option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</option>
            </select>
            <input name="lastName" placeholder="–§–∞–º–∏–ª–∏—è" required>
            <input name="firstName" placeholder="–ò–º—è" required>
            <input name="middleName" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ">
            <input name="barcode" placeholder="–®—Ç—Ä–∏—Ö–∫–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ - –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)">
            <textarea name="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
            <input type="file" name="photo" accept="image/*">
            <button type="submit">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</button>
        </form>
        <div id="qr-result" class="hidden"></div>
    </div>

    <!-- –°–æ–±—ã—Ç–∏—è -->
    <div id="events" class="content">
        <button onclick="app.events.showCreateForm()">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
        <div id="events-list"></div>
    </div>

    <!-- –°–∫–∞–Ω–µ—Ä -->
    <div id="scanner" class="content">
        <video id="qr-video" class="hidden"></video>
        <button id="scanner-btn" onclick="app.scanner.toggle()">üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
        <div id="scan-result" class="hidden"></div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="stats" class="content">
        <div id="stats-overview" class="stats-grid"></div>
        <div id="stats-tables"></div>
    </div>

    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div id="admin" class="content">
        <button onclick="app.admin.showCreateUserForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <div id="users-table">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div id="users-pagination" class="pagination hidden"></div>
    </div>
</div>

<script>
    // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const app = {
        state: {
            currentUser: null,
            visitors: [],
            events: [],
            users: [],
            pagination: {
                visitors: { page: 1, size: 25, total: 0 },
                users: { page: 1, size: 25, total: 0 }
            }
        },

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');

            this.setupEventListeners();

            if (await this.auth.check()) {
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    console.log('üìã –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...');
                    await this.events.loadActiveForFilters();

                    // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
                    console.log('üë• –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π...');
                    await this.visitors.load();

                    // –ò —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    console.log('üìä –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                    await this.stats.load();

                    console.log('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                } catch (err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + err.message);
                }
            }
        },

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => this.showTab(tab.dataset.tab);
            });

            // –ü–æ–∏—Å–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
            document.getElementById('search-input').oninput =
                this.debounce(() => this.visitors.load(1), 500);

            // –§–∏–ª—å—Ç—Ä—ã
            document.getElementById('status-filter').onchange = () => this.visitors.load(1);
            document.getElementById('event-filter').onchange = () => this.visitors.load(1);

            // –§–æ—Ä–º–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
            document.getElementById('visitor-form').onsubmit = (e) => this.visitors.create(e);
        },

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        showTab(tab) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            const loaders = {
                visitors: async () => {
                    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π - –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π');
                    try {
                        await this.events.loadActiveForFilters();
                        this.visitors.load();
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
                    }
                },
                'add-visitor': () => this.events.loadActiveForForm(),
                events: () => this.events.load(),
                stats: () => this.stats.load(),
                admin: () => this.admin.load()
            };

            if (loaders[tab]) {
                try {
                    loaders[tab]();
                } catch (err) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ ${tab}:`, err);
                }
            }
        },

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async logout() {
            try {
                const res = await fetch('/api/auth/logout', { method: 'POST' });

                if (res.ok) {
                    window.location.href = '/login';
                } else {
                    this.showAlert('error', '–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
                // –î–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ —É–¥–∞–ª—Å—è, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ login
                window.location.href = '/login';
            }
        },

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        auth: {
            async check() {
                try {
                    const res = await fetch('/api/auth/check');
                    const data = await res.json();

                    if (!data.authenticated) {
                        window.location.href = '/login';
                        return false;
                    }

                    app.state.currentUser = data.user;
                    app.updateUserInterface();
                    return true;
                } catch (err) {
                    window.location.href = '/login';
                    return false;
                }
            }
        },

        // –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏
        visitors: {
            async load(page = 1) {
                const container = document.getElementById('visitors-table');

                try {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
                    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π...</div>';

                    const params = new URLSearchParams({
                        page,
                        limit: app.state.pagination.visitors.size,
                        search: document.getElementById('search-input').value,
                        status: document.getElementById('status-filter').value,
                        event_id: document.getElementById('event-filter').value
                    });

                    const res = await fetch(`/api/visitors?${params}`);

                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }

                    const data = await res.json();

                    app.state.visitors = data.visitors || [];
                    app.state.pagination.visitors = data.pagination || { page: 1, size: 25, total: 0, pages: 1 };

                    this.render();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π:', err);
                    container.innerHTML = `
                        <div class="empty" style="color: #dc3545;">
                            <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h3>
                            <p>${err.message}</p>
                            <button onclick="app.visitors.load()" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        </div>
                    `;
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: ' + err.message);
                }
            },

            render() {
                const container = document.getElementById('visitors-table');
                const visitors = app.state.visitors;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π
                const countElement = document.getElementById('visitors-count');
                if (countElement) {
                    countElement.textContent = visitors ? visitors.length : 0;
                }

                if (!visitors || visitors.length === 0) {
                    container.innerHTML = `
                        <div class="empty">
                            <h3>üë• –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</p>
                            <button onclick="app.showTab('add-visitor')" style="margin-top: 15px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è</button>
                        </div>
                    `;

                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                    const pagination = document.getElementById('visitors-pagination');
                    if (pagination) pagination.classList.add('hidden');
                    return;
                }

                container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>–§–ò–û</th>
                            <th>–®—Ç—Ä–∏—Ö–∫–æ–¥</th>
                            <th>–°–æ–±—ã—Ç–∏–µ</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${visitors.map(v => `
                            <tr>
                                <td>
                                    <strong>${v.last_name} ${v.first_name} ${v.middle_name || ''}</strong>
                                    ${v.comment ? `<br><small>${v.comment}</small>` : ''}
                                </td>
                                <td><code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${v.barcode || '–ù–µ—Ç'}</code></td>
                                <td><span class="badge">${v.event?.name || '–ë–µ–∑ —Å–æ–±—ã—Ç–∏—è'}</span></td>
                                <td><span class="status-${v.status}">${v.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span></td>
                                <td>${v.total_scans} ${v.first_scan_today ? '(—Å–µ–≥–æ–¥–Ω—è)' : ''}</td>
                                <td>
                                    <button onclick="app.visitors.downloadQR(${v.id})" title="–°–∫–∞—á–∞—Ç—å QR">üì•</button>
                                    <button onclick="app.visitors.toggleStatus(${v.id}, '${v.status}')" title="${v.status === 'active' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}">${v.status === 'active' ? 'üîí' : 'üîì'}</button>
                                    ${app.state.currentUser.role === 'admin' ? `<button onclick="app.visitors.delete(${v.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                app.renderPagination('visitors');
            },

            async create(e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const res = await fetch('/api/visitors', { method: 'POST', body: formData });
                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                        this.showQRResult(data.visitor);
                    } else {
                        app.showAlert('error', data.error);
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è');
                }
            },

            showQRResult(visitor) {
                const qrData = visitor.barcode; // –¢–µ–ø–µ—Ä—å QR —Å–æ–¥–µ—Ä–∂–∏—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥
                const container = document.getElementById('qr-result');

                container.innerHTML = `
                <div class="qr-container">
                    <canvas id="qr-canvas"></canvas>
                    <p>QR-–∫–æ–¥ –¥–ª—è ${visitor.last_name} ${visitor.first_name}</p>
                    <p><strong>–®—Ç—Ä–∏—Ö–∫–æ–¥:</strong> <code>${visitor.barcode}</code></p>
                    <button onclick="app.visitors.downloadQRCanvas()">üì• –°–∫–∞—á–∞—Ç—å</button>
                    <button onclick="app.visitors.resetForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ</button>
                </div>
            `;
                container.classList.remove('hidden');

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.getElementById('qr-canvas'), qrData);
                }
            },

            async downloadQR(id) {
                try {
                    const res = await fetch(`/api/visitors/${id}/qr`);
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `visitor-qr-${id}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR');
                }
            },

            downloadQRCanvas() {
                const canvas = document.getElementById('qr-canvas');
                if (canvas) {
                    const link = document.createElement('a');
                    link.download = 'visitor-qr-code.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }
            },

            async toggleStatus(id, currentStatus) {
                const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
                const action = newStatus === 'active' ? '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';

                if (!confirm(`${action} –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?`)) return;

                try {
                    const res = await fetch(`/api/visitors/${id}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async delete(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è?')) return;

                try {
                    const res = await fetch(`/api/visitors/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        app.showAlert('success', '–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            filter() {
                this.load(1);
            },

            resetFilters() {
                document.getElementById('search-input').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('event-filter').value = '';
                this.load(1);
            },

            resetForm() {
                document.getElementById('visitor-form').reset();
                document.getElementById('qr-result').classList.add('hidden');
            },

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API —Å–æ–±—ã—Ç–∏–π
            testEventsAPI() {
                console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å–æ–±—ã—Ç–∏–π...');

                // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π endpoint —Å–æ–±—ã—Ç–∏–π
                console.log('üì° –¢–µ—Å—Ç 1: /api/events');
                fetch('/api/events')
                    .then(response => {
                        console.log('üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ /api/events:', response.status, response.statusText);
                        return response.json();
                    })
                    .then(data => {
                        console.log('üìä –û—Ç–≤–µ—Ç /api/events:', data);
                        if (data.events) {
                            console.log(`üìä –í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π: ${data.events.length}`);
                            const activeEvents = data.events.filter(e => e.status === 'active');
                            console.log(`üìä –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π: ${activeEvents.length}`);

                            activeEvents.forEach((event, i) => {
                                console.log(`  ${i + 1}. ${event.name} (ID: ${event.id}, –¥–æ: ${event.end_date})`);
                            });
                        } else {
                            console.log('‚ö†Ô∏è –ù–µ—Ç –ø–æ–ª—è events –≤ –æ—Ç–≤–µ—Ç–µ /api/events');
                        }
                    })
                    .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ /api/events:', err));

                // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint
                console.log('üì° –¢–µ—Å—Ç 2: /api/visitors/events/active');
                fetch('/api/visitors/events/active')
                    .then(response => {
                        console.log('üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ /api/visitors/events/active:', response.status, response.statusText);
                        return response.text();
                    })
                    .then(text => {
                        console.log('üìä –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç /api/visitors/events/active:', text);
                        try {
                            const data = JSON.parse(text);
                            console.log('üìä –ü–∞—Ä—Å–∏–Ω–≥ JSON —É—Å–ø–µ—à–µ–Ω:', data);
                        } catch (e) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
                        }
                    })
                    .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ /api/visitors/events/active:', err));

                // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
                console.log('üì° –¢–µ—Å—Ç 3: –°–æ—Å—Ç–æ—è–Ω–∏–µ DOM');
                const filter = document.getElementById('event-filter');
                if (filter) {
                    console.log('üìä –§–∏–ª—å—Ç—Ä –Ω–∞–π–¥–µ–Ω, –æ–ø—Ü–∏–π:', filter.options.length);
                    for (let i = 0; i < filter.options.length; i++) {
                        console.log(`  ${i}: "${filter.options[i].text}" (value: "${filter.options[i].value}")`);
                    }
                } else {
                    console.error('‚ùå –§–∏–ª—å—Ç—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
                }

                // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É
                const formSelect = document.querySelector('#visitor-form select[name="eventId"]');
                if (formSelect) {
                    console.log('üìä –§–æ—Ä–º–∞ –Ω–∞–π–¥–µ–Ω–∞, –æ–ø—Ü–∏–π:', formSelect.options.length);
                    for (let i = 0; i < formSelect.options.length; i++) {
                        console.log(`  –§–æ—Ä–º–∞ ${i}: "${formSelect.options[i].text}" (value: "${formSelect.options[i].value}")`);
                    }
                } else {
                    console.error('‚ùå –§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM');
                }

                app.showAlert('info', '–¢–µ—Å—Ç API –∑–∞–ø—É—â–µ–Ω, —Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
            }
        },

        // –°–æ–±—ã—Ç–∏—è
        events: {
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏"
            async loadActiveForFilters() {
                try {
                    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞...');

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –î–û –∑–∞–ø—Ä–æ—Å–∞
                    const filter = document.getElementById('event-filter');
                    if (!filter) {
                        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç event-filter –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º');
                        return;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    filter.innerHTML = '<option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</option>';

                    console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API...');

                    let data;
                    let success = false;

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ endpoints –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π API —Å–æ–±—ã—Ç–∏–π
                    try {
                        console.log('üéØ –ü–æ–ø—ã—Ç–∫–∞ #1: /api/events');
                        const eventsRes = await fetch('/api/events?active_only=true');
                        if (eventsRes.ok) {
                            data = await eventsRes.json();
                            console.log('üìä –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç /api/events:', data);
                            success = true;
                        } else {
                            console.log(`‚ùå /api/events –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${eventsRes.status}`);
                        }
                    } catch (eventsError) {
                        console.log('‚ùå /api/events failed:', eventsError.message);
                    }

                    // 2. –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π
                    if (!success) {
                        try {
                            console.log('üéØ –ü–æ–ø—ã—Ç–∫–∞ #2: /api/visitors/events/active');
                            const visitorsRes = await fetch('/api/visitors/events/active');
                            if (visitorsRes.ok) {
                                data = await visitorsRes.json();
                                console.log('üìä –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç /api/visitors/events/active:', data);
                                success = true;
                            } else {
                                console.log(`‚ùå /api/visitors/events/active –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${visitorsRes.status}`);
                            }
                        } catch (visitorsError) {
                            console.log('‚ùå /api/visitors/events/active failed:', visitorsError.message);
                        }
                    }

                    if (!success) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∏ –∏–∑ –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ü–û–°–õ–ï –∑–∞–ø—Ä–æ—Å–∞
                    const filterAfter = document.getElementById('event-filter');
                    if (!filterAfter) {
                        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç event-filter –∏—Å—á–µ–∑ –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞');
                        return;
                    }

                    console.log('üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞...');
                    filterAfter.innerHTML = '<option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>';

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                    let events = [];

                    if (data.events && Array.isArray(data.events)) {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
                        events = data.events.filter(event =>
                            event.status === 'active' &&
                            new Date(event.end_date) >= new Date()
                        );
                    } else if (data.success && data.events && Array.isArray(data.events)) {
                        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç /api/visitors/events/active
                        events = data.events;
                    } else {
                        console.log('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:', data);
                    }

                    console.log('üìã –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', events);

                    if (events.length > 0) {
                        console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä...');
                        events.forEach((event, index) => {
                            console.log(`  üìå –°–æ–±—ã—Ç–∏–µ ${index + 1}:`, {
                                id: event.id,
                                name: event.name,
                                status: event.status,
                                end_date: event.end_date
                            });

                            const option = document.createElement('option');
                            option.value = event.id;
                            option.textContent = `${event.name}${event.location ? ` (${event.location})` : ''}`;
                            filterAfter.appendChild(option);
                        });
                        console.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${events.length} —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä`);
                    } else {
                        console.log('‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π');
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π';
                        option.disabled = true;
                        filterAfter.appendChild(option);
                    }

                    console.log('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                } catch (err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞:', err);

                    const filter = document.getElementById('event-filter');
                    if (filter) {
                        filter.innerHTML = '<option value="">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option><option value="" disabled>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                    }

                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞: ' + err.message);
                }
            },

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è
            async loadActiveForForm() {
                try {
                    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã...');

                    const select = document.querySelector('#visitor-form select[name="eventId"]');
                    if (!select) {
                        console.error('–≠–ª–µ–º–µ–Ω—Ç select[name="eventId"] –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–æ—Ä–º–µ');
                        return;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    select.innerHTML = '<option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</option>';

                    let data;
                    let success = false;

                    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ endpoints
                    try {
                        console.log('üéØ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã: /api/events');
                        const eventsRes = await fetch('/api/events?active_only=true');
                        if (eventsRes.ok) {
                            data = await eventsRes.json();
                            success = true;
                        } else {
                            console.log(`‚ùå /api/events –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ñ–æ—Ä–º—ã: ${eventsRes.status}`);
                        }
                    } catch (eventsError) {
                        console.log('‚ùå /api/events failed –¥–ª—è —Ñ–æ—Ä–º—ã:', eventsError.message);
                    }

                    if (!success) {
                        try {
                            console.log('üéØ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã: /api/visitors/events/active');
                            const visitorsRes = await fetch('/api/visitors/events/active');
                            if (visitorsRes.ok) {
                                data = await visitorsRes.json();
                                success = true;
                            } else {
                                console.log(`‚ùå /api/visitors/events/active –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ñ–æ—Ä–º—ã: ${visitorsRes.status}`);
                            }
                        } catch (visitorsError) {
                            console.log('‚ùå /api/visitors/events/active failed –¥–ª—è —Ñ–æ—Ä–º—ã:', visitorsError.message);
                        }
                    }

                    if (!success) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Ñ–æ—Ä–º—ã');
                    }

                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option>';

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                    let events = [];
                    if (data.events && Array.isArray(data.events)) {
                        events = data.events.filter(event =>
                            event.status === 'active' &&
                            new Date(event.end_date) >= new Date()
                        );
                    } else if (data.success && data.events && Array.isArray(data.events)) {
                        events = data.events;
                    }

                    if (events.length > 0) {
                        events.forEach(event => {
                            const option = document.createElement('option');
                            option.value = event.id;
                            option.textContent = `${event.name} (${this.formatDate(event.start_date)})`;
                            select.appendChild(option);
                        });
                        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${events.length} —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º—É`);
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π';
                        option.disabled = true;
                        select.appendChild(option);
                        console.log('‚ÑπÔ∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã');
                    }

                    console.log('‚úÖ –§–æ—Ä–º–∞ —Å–æ–±—ã—Ç–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                } catch (err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã:', err);

                    const select = document.querySelector('#visitor-form select[name="eventId"]');
                    if (select) {
                        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ</option><option value="" disabled>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
                    }

                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–æ—Ä–º—ã: ' + err.message);
                }
            },

            async load() {
                try {
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π...');
                    const res = await fetch('/api/events');

                    if (!res.ok) {
                        // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
                        console.log('API —Å–æ–±—ã—Ç–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π...');
                        await this.createTestEventsIfNeeded();

                        const errorData = await res.json().catch(() => ({ error: 'API —Å–æ–±—ã—Ç–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω' }));
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    console.log('–°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data);

                    // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ
                    if (!data.events || data.events.length === 0) {
                        console.log('–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ...');
                        await this.createTestEventsIfNeeded();

                        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–Ω–æ–≤–∞
                        const retryRes = await fetch('/api/events');
                        if (retryRes.ok) {
                            const retryData = await retryRes.json();
                            app.state.events = retryData.events || [];
                        } else {
                            app.state.events = [];
                        }
                    } else {
                        app.state.events = data.events || [];
                    }

                    this.render();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π: ' + err.message);

                    const container = document.getElementById('events-list');
                    if (container) {
                        container.innerHTML = `
                    <div class="empty" style="color: #dc3545;">
                        <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</h3>
                        <p>${err.message}</p>
                        <button onclick="app.events.load()" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        <button onclick="app.events.createTestEventsIfNeeded()" style="margin-top: 10px;">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</button>
                    </div>
                `;
                    }
                }
            },

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            async createTestEventsIfNeeded() {
                try {
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π...');

                    const testEvents = [
                        {
                            name: 'IT-–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è 2024',
                            description: '–ï–∂–µ–≥–æ–¥–Ω–∞—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è –ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º',
                            start_date: '2024-12-01',
                            end_date: '2024-12-31',
                            location: '–ú–æ—Å–∫–≤–∞, –¶–í–ö "–≠–∫—Å–ø–æ—Ü–µ–Ω—Ç—Ä"',
                            status: 'active'
                        },
                        {
                            name: '–í—ã—Å—Ç–∞–≤–∫–∞ –∏–Ω–Ω–æ–≤–∞—Ü–∏–π',
                            description: '–í—ã—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤',
                            start_date: '2024-11-15',
                            end_date: '2024-12-15',
                            location: '–°–ü–±, –õ–µ–Ω—ç–∫—Å–ø–æ',
                            status: 'active'
                        },
                        {
                            name: '–°–µ–º–∏–Ω–∞—Ä –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                            description: '–û–±—É—á–∞—é—â–∏–π —Å–µ–º–∏–Ω–∞—Ä –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
                            start_date: '2024-11-01',
                            end_date: '2024-12-01',
                            location: '–û–Ω–ª–∞–π–Ω',
                            status: 'active'
                        }
                    ];

                    let createdCount = 0;
                    for (const eventData of testEvents) {
                        try {
                            const res = await fetch('/api/events', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(eventData)
                            });

                            if (res.ok) {
                                createdCount++;
                                console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ${eventData.name}`);
                            } else {
                                console.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ: ${eventData.name}`);
                            }
                        } catch (err) {
                            console.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è ${eventData.name}:`, err.message);
                        }
                    }

                    if (createdCount > 0) {
                        app.showAlert('success', `–°–æ–∑–¥–∞–Ω–æ ${createdCount} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π`);
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                        await this.loadActiveForFilters();
                        await this.loadActiveForForm();
                    } else {
                        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è');
                    }

                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π:', err);
                }
            },

            render() {
                const container = document.getElementById('events-list');
                if (!container) {
                    console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä events-list –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                const events = app.state.events;

                if (!events || events.length === 0) {
                    container.innerHTML = `
                <div class="empty">
                    <h3>üìã –°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏</p>
                    <button onclick="app.events.showCreateForm()" style="margin-top: 15px;">‚ûï –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                    <button onclick="app.events.createTestEventsIfNeeded()" style="margin-top: 10px;">üéØ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è</button>
                </div>
            `;
                    return;
                }

                container.innerHTML = events.map(e => `
            <div class="event-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <h3>${e.name}</h3>
                    <span class="status-${e.status}" style="font-size: 12px; padding: 4px 8px;">
                        ${this.getStatusText(e.status)}
                    </span>
                </div>

                ${e.description ? `<p style="color: #666; margin-bottom: 10px;">${e.description}</p>` : ''}

                <div style="margin-bottom: 10px;">
                    <p><strong>üìÖ –î–∞—Ç—ã:</strong> ${this.formatDate(e.start_date)} - ${this.formatDate(e.end_date)}</p>
                    ${e.location ? `<p><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${e.location}</p>` : ''}
                    ${e.max_participants ? `<p><strong>üë• –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> ${e.max_participants}</p>` : ''}
                </div>

                <div class="stats">
                    <span title="–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π">üë• ${e.stats?.total_visitors || 0}</span>
                    <span title="–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π">‚úÖ ${e.stats?.active_visitors || 0}</span>
                    <span title="–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π">üì± ${e.stats?.total_scans || 0}</span>
                    <span title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è">üìä ${e.stats?.today_scans || 0}</span>
                </div>

                ${app.state.currentUser.role !== 'skd' ? `
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="app.events.viewDetails(${e.id})" style="font-size: 12px; padding: 6px 12px;">üìã –ü–æ–¥—Ä–æ–±–Ω–æ</button>
                        ${app.state.currentUser.role === 'admin' || app.state.currentUser.role === 'moderator' ? `
                            <button onclick="app.events.showEditForm(${e.id})" style="font-size: 12px; padding: 6px 12px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="app.events.toggleStatus(${e.id}, '${e.status}')" style="font-size: 12px; padding: 6px 12px;">
                                ${e.status === 'active' ? '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                        ` : ''}
                        ${app.state.currentUser.role === 'admin' ? `
                            <button onclick="app.events.delete(${e.id})" style="font-size: 12px; padding: 6px 12px; background: #dc3545;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `).join('');
            },

            getStatusText(status) {
                const statusMap = {
                    'active': '–ê–∫—Ç–∏–≤–Ω–æ',
                    'inactive': '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ',
                    'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                    'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
                };
                return statusMap[status] || status;
            },

            formatDate(dateString) {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('ru-RU');
            },

            showCreateForm() {
                app.showModal(`
            <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
            <form id="event-form">
                <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" required>
                <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                        <input name="start_date" type="date" required>
                    </div>
                    <div>
                        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                        <input name="end_date" type="date" required>
                    </div>
                </div>
                <input name="location" placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <input name="max_participants" type="number" placeholder="–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" min="1">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input name="registration_required" type="checkbox">
                    –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </label>
                <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            </form>
        `, async (formData) => {
                    try {
                        const eventData = Object.fromEntries(formData);
                        eventData.registration_required = formData.get('registration_required') === 'on';

                        Object.keys(eventData).forEach(key => {
                            if (eventData[key] === '' || eventData[key] === null) {
                                delete eventData[key];
                            }
                        });

                        const res = await fetch('/api/events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        });

                        const data = await res.json();

                        if (res.ok) {
                            app.showAlert('success', '–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                            this.load();
                            try {
                                await this.loadActiveForFilters();
                                await this.loadActiveForForm();
                            } catch (err) {
                                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                            }
                        } else {
                            throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                        }
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                    }
                });
            },

            async viewDetails(id) {
                try {
                    const res = await fetch(`/api/events/${id}`);
                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏—è');
                    }

                    app.showModal(`
                <h3>üìã ${data.name}</h3>
                <div style="text-align: left;">
                    ${data.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${data.description}</p>` : ''}
                    <p><strong>üìÖ –ü–µ—Ä–∏–æ–¥:</strong> ${this.formatDate(data.start_date)} - ${this.formatDate(data.end_date)}</p>
                    ${data.location ? `<p><strong>üìç –ú–µ—Å—Ç–æ:</strong> ${data.location}</p>` : ''}
                    <p><strong>üìä –°—Ç–∞—Ç—É—Å:</strong> ${this.getStatusText(data.status)}</p>
                    ${data.max_participants ? `<p><strong>üë• –ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> ${data.max_participants}</p>` : ''}
                    <p><strong>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</strong> ${data.registration_required ? '–¢—Ä–µ–±—É–µ—Ç—Å—è' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}</p>

                    <h4 style="margin-top: 20px;">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π: <strong>${data.stats?.total_visitors || 0}</strong></div>
                        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö: <strong>${data.stats?.active_visitors || 0}</strong></div>
                        <div>–í—Å–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: <strong>${data.stats?.total_scans || 0}</strong></div>
                        <div>–°–µ–≥–æ–¥–Ω—è: <strong>${data.stats?.today_scans || 0}</strong></div>
                    </div>

                    ${data.created_by_name ? `<p style="margin-top: 15px; font-size: 12px; color: #666;">–°–æ–∑–¥–∞–Ω–æ: ${data.created_by_name}</p>` : ''}
                </div>
            `);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                }
            },

            async toggleStatus(id, currentStatus) {
                const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                const action = newStatus === 'active' ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';

                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?`)) return;

                try {
                    const res = await fetch(`/api/events/${id}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', data.message);
                        this.load();
                        try {
                            await this.loadActiveForFilters();
                            await this.loadActiveForForm();
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
                        }
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + err.message);
                }
            },

            async delete(id) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

                try {
                    const res = await fetch(`/api/events/${id}`, { method: 'DELETE' });
                    const data = await res.json();

                    if (res.ok) {
                        app.showAlert('success', data.message);
                        this.load();
                        try {
                            await this.loadActiveForFilters();
                            await this.loadActiveForForm();
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                        }
                    } else {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', err);
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + err.message);
                }
            }
        },

        // –°–∫–∞–Ω–µ—Ä
        scanner: {
            instance: null,

            toggle() {
                if (this.instance) {
                    this.stop();
                } else {
                    this.start();
                }
            },

            async start() {
                if (typeof QrScanner === 'undefined') {
                    app.showAlert('error', 'QR —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }

                const video = document.getElementById('qr-video');
                const btn = document.getElementById('scanner-btn');

                this.instance = new QrScanner(video, result => {
                    this.handleResult(result.data);
                });

                try {
                    await this.instance.start();
                    video.classList.remove('hidden');
                    btn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
                }
            },

            stop() {
                if (this.instance) {
                    this.instance.stop();
                    this.instance = null;
                    document.getElementById('qr-video').classList.add('hidden');
                    document.getElementById('scanner-btn').textContent = 'üìπ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä';
                }
            },

            async handleResult(qrData) {
                let barcode = null;

                // –ï—Å–ª–∏ QR —Å–æ–¥–µ—Ä–∂–∏—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é
                if (qrData.match(/^VIS\d+$/)) {
                    barcode = qrData;
                } else if (qrData.includes('/scan/')) {
                    // –ï—Å–ª–∏ QR —Å–æ–¥–µ—Ä–∂–∏—Ç URL
                    barcode = qrData.split('/scan/')[1];
                } else {
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤ —Å—Ç—Ä–æ–∫–µ
                    const match = qrData.match(/VIS\d+/);
                    if (match) {
                        barcode = match[0];
                    }
                }

                if (!barcode) {
                    app.showAlert('error', '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR –∫–æ–¥');
                    return;
                }

                try {
                    const res = await fetch(`/api/scan/${barcode}`);
                    const data = await res.json();

                    this.showResult(data);
                    this.stop();
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
            },

            showResult(data) {
                const container = document.getElementById('scan-result');

                const statusClass = {
                    success: 'success',
                    warning: 'warning',
                    error: 'error'
                }[data.status] || 'info';

                container.innerHTML = `
                <div class="alert alert-${statusClass}">
                    <h4>${data.icon} ${data.title}</h4>
                    ${data.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.comment}</p>` : ''}
                    <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(data.scanTime || data.currentScanTime).toLocaleString()}</p>
                </div>
            `;
                container.classList.remove('hidden');
            }
        },

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats: {
            async load() {
                try {
                    const res = await fetch('/api/visitors/stats/overview');
                    const data = await res.json();

                    this.render(data);
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }
            },

            render(data) {
                const overview = document.getElementById('stats-overview');
                overview.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.visitors?.total_visitors || 0}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.visitors?.active_visitors || 0}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans?.today_scans || 0}</div>
                    <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.scans?.week_scans || 0}</div>
                    <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
            `;
            }
        },

        // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        admin: {
            async load() {
                const container = document.getElementById('users-table');

                if (app.state.currentUser.role !== 'admin') {
                    container.innerHTML = `
                        <div class="empty">
                            <h3>üîí –î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
                            <p>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
                        </div>
                    `;
                    return;
                }

                try {
                    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';

                    const res = await fetch('/api/admin/users');
                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                    }

                    app.state.users = data.users || [];
                    this.render();
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', err);
                    container.innerHTML = `
                        <div class="empty" style="color: #dc3545;">
                            <h3>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                            <p>${err.message}</p>
                            <button onclick="app.admin.load()" style="margin-top: 10px;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        </div>
                    `;
                    app.showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + err.message);
                }
            },

            render() {
                const container = document.getElementById('users-table');
                const users = app.state.users;

                if (!users || users.length === 0) {
                    container.innerHTML = `
                        <div class="empty">
                            <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
                            <button onclick="app.admin.showCreateUserForm()" style="margin-top: 15px;">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                <div class="table-container">
                    <div class="table-header">
                        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</span>
                        <span>${users.length}</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–†–æ–ª—å</th>
                                <th>Email</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr>
                                    <td>
                                        <strong>${u.fullName}</strong><br>
                                        <small>@${u.username}</small>
                                    </td>
                                    <td><span class="role-${u.role}">${app.getRoleText(u.role)}</span></td>
                                    <td>${u.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                    <td><span class="status-${u.isActive ? 'active' : 'blocked'}">${u.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</span></td>
                                    <td>
                                        <button onclick="app.admin.resetPassword(${u.id})" title="–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å">üîë</button>
                                        <button onclick="app.admin.toggleStatus(${u.id}, ${u.isActive})" ${u.id === app.state.currentUser.id ? 'disabled' : ''} title="${u.isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}">${u.isActive ? 'üîí' : 'üîì'}</button>
                                        ${u.id !== app.state.currentUser.id ? `<button onclick="app.admin.deleteUser(${u.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            },

            showCreateUserForm() {
                app.showModal(`
                <h3>–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                <form id="user-form">
                    <input name="username" placeholder="–õ–æ–≥–∏–Ω" required>
                    <input name="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                    <input name="fullName" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è" required>
                    <select name="role" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                        <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                        <option value="skd">–°–ö–î</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                    <input name="email" type="email" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
                </form>
            `, async (formData) => {
                    try {
                        const userData = Object.fromEntries(formData);

                        Object.keys(userData).forEach(key => {
                            if (userData[key] === '' || userData[key] === null) {
                                delete userData[key];
                            }
                        });

                        const res = await fetch('/api/admin/users', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(userData)
                        });

                        const data = await res.json();

                        if (res.ok) {
                            app.showAlert('success', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                            this.load();
                        } else {
                            app.showAlert('error', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        }
                    } catch (err) {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
                    }
                });
            },

            async resetPassword(id) {
                const password = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
                if (!password) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: password })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω');
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async toggleStatus(id, isActive) {
                if (!confirm(isActive ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å?')) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ isActive: !isActive })
                    });

                    if (res.ok) {
                        app.showAlert('success', '–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            },

            async deleteUser(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

                try {
                    const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        app.showAlert('success', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                        this.load();
                    } else {
                        app.showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (err) {
                    app.showAlert('error', '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            }
        },

        // –£—Ç–∏–ª–∏—Ç—ã
        updateUserInterface() {
            const user = this.state.currentUser;
            document.getElementById('user-badge').textContent = `${user.fullName} (${this.getRoleText(user.role)})`;

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –≤–∫–ª–∞–¥–∫–∞–º
            const adminTab = document.querySelector('[data-tab="admin"]');

            if (user.role === 'skd') {
                // –°–ö–î –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–∫–∞–Ω–µ—Ä
                document.querySelectorAll('.tab').forEach(t => {
                    t.disabled = !['scanner'].includes(t.dataset.tab);
                });
                this.showTab('scanner');
            } else if (user.role === 'admin') {
                // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ, –≤–∫–ª—é—á–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.querySelectorAll('.tab').forEach(t => t.disabled = false);
                if (adminTab) adminTab.disabled = false;
            } else if (user.role === 'moderator') {
                // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –≤—Å–µ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
                document.querySelectorAll('.tab').forEach(t => {
                    t.disabled = t.dataset.tab === 'admin';
                });
                if (adminTab) adminTab.disabled = true;
            }
        },

        getRoleText(role) {
            return { admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', moderator: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', skd: '–°–ö–î' }[role] || role;
        },

        showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        },

        showModal(html, onSubmit) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `<div class="modal-content">${html}</div>`;
            document.body.appendChild(modal);

            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            if (onSubmit) {
                modal.querySelector('form').onsubmit = async (e) => {
                    e.preventDefault();
                    await onSubmit(new FormData(e.target));
                    modal.remove();
                };
            }
        },

        renderPagination(type) {
            const container = document.getElementById(`${type}-pagination`);
            const pagination = this.state.pagination[type];

            if (pagination.total <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.innerHTML = `
            <button onclick="app.${type}.load(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>‚Üê</button>
            <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${pagination.pages}</span>
            <button onclick="app.${type}.load(${pagination.page + 1})" ${pagination.page === pagination.pages ? 'disabled' : ''}>‚Üí</button>
        `;
            container.classList.remove('hidden');
        },

        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    };

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞)
    window.debugApp = {
        testEventsAPI: () => app.visitors.testEventsAPI(),
        loadEvents: () => app.events.loadActiveForFilters(),
        state: () => console.log('App state:', app.state),
        checkAuth: () => app.auth.check(),
        createTestEvents: () => app.events.createTestEventsIfNeeded(),

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        forceUpdateFilter: async () => {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞...');
            const filter = document.getElementById('event-filter');
            if (!filter) {
                console.error('‚ùå –§–∏–ª—å—Ç—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            filter.innerHTML = '<option value="">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</option>';

            try {
                await app.events.loadActiveForFilters();
                console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
            } catch (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
                filter.innerHTML = '<option value="">‚ùå –û—à–∏–±–∫–∞</option>';
            }
        },

        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        diagnose: async () => {
            console.log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Å–æ–±—ã—Ç–∏–π...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            const apiTests = [
                { name: '–°–æ–±—ã—Ç–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π)', url: '/api/events' },
                { name: '–°–æ–±—ã—Ç–∏—è (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)', url: '/api/visitors/events/active' },
                { name: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', url: '/api/auth/check' }
            ];

            for (const test of apiTests) {
                try {
                    const res = await fetch(test.url);
                    const data = await res.json();
                    console.log(`‚úÖ ${test.name}:`, res.status, data);
                } catch (err) {
                    console.log(`‚ùå ${test.name}:`, err.message);
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM
            const elements = [
                'event-filter',
                'visitor-form',
                'events-list'
            ];

            elements.forEach(id => {
                const el = document.getElementById(id);
                console.log(`${el ? '‚úÖ' : '‚ùå'} –≠–ª–µ–º–µ–Ω—Ç #${id}:`, el ? '–Ω–∞–π–¥–µ–Ω' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            console.log('üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:');
            console.log('- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', app.state.currentUser);
            console.log('- –°–æ–±—ã—Ç–∏—è:', app.state.events?.length || 0);
            console.log('- –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏:', app.state.visitors?.length || 0);
        }
    };

    console.log('üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ª–∞–¥–∫–∏: window.debugApp');
    console.log('   - debugApp.testEventsAPI() - —Ç–µ—Å—Ç API —Å–æ–±—ã—Ç–∏–π');
    console.log('   - debugApp.loadEvents() - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π');
    console.log('   - debugApp.forceUpdateFilter() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');
    console.log('   - debugApp.createTestEvents() - —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è');
    console.log('   - debugApp.diagnose() - –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞');
    console.log('   - debugApp.state() - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>